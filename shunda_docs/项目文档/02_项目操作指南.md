# 项目操作指南

> **文档版本**: v1.0
> **更新日期**: 2025-11-16
> **适用人员**: 产品经理、测试人员、开发人员

---

## 目录

1. [快速开始](#快速开始)
2. [Web 自动化](#web-自动化)
3. [Android 自动化](#android-自动化)
4. [iOS 自动化](#ios-自动化)
5. [YAML 脚本使用](#yaml-脚本使用)
6. [命令行工具](#命令行工具)
7. [Playground 使用](#playground-使用)
8. [调试技巧](#调试技巧)
9. [常见问题](#常见问题)

---

## 快速开始

### 第一步: 环境配置

```bash
# 1. 克隆项目
git clone <repository-url>
cd auto_test

# 2. 安装依赖
corepack enable
pnpm install

# 3. 构建项目
pnpm run build

# 4. 配置 AI 模型
cp .env.example .env
# 编辑 .env 文件,填入您的 API Key
```

### 第二步: 配置 .env

在项目根目录创建 `.env` 文件:

```bash
# 主模型 (视觉理解)
SILICONFLOW_API_KEY=sk-your-key-here
SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICONFLOW_MODEL=Qwen/Qwen2.5-VL

# 规划器模型 (任务规划)
DEEPSEEK_API_KEY=sk-your-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
```

### 第三步: 运行示例

```bash
# 运行 Web 自动化示例
cd packages/web-integration
npm run demo

# 或运行 CLI 测试
npx midscene run tests/fixtures/example.yaml
```

---

## Web 自动化

### 1. 使用 Playwright

#### 基本示例

```typescript
// test.spec.ts
import { PlaywrightAgent } from '@midscene/web/playwright';
import { chromium } from 'playwright';

async function main() {
  // 1. 启动浏览器
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  // 2. 创建 Agent
  const agent = await PlaywrightAgent.create(page, {
    generateReport: true,
    groupName: '我的测试'
  });

  // 3. 导航到页面
  await page.goto('https://www.bing.com');

  // 4. 执行自动化任务
  await agent.aiAction('在搜索框中输入 "Midscene.js" 并搜索');

  // 5. 数据提取
  const results = await agent.aiQuery<string[]>(
    'array<string>, 提取前5条搜索结果的标题'
  );
  console.log('搜索结果:', results);

  // 6. 断言验证
  await agent.aiAssert('页面显示搜索结果,至少有5条');

  // 7. 清理
  await browser.close();
}

main();
```

#### 运行测试

```bash
# 安装依赖
npm install playwright @midscene/web

# 运行
npx ts-node test.spec.ts
```

### 2. 使用 Puppeteer

```typescript
import { PuppeteerAgent } from '@midscene/web/puppeteer';
import puppeteer from 'puppeteer';

async function main() {
  const browser = await puppeteer.launch({ headless: false });
  const page = await browser.newPage();

  const agent = await PuppeteerAgent.create(page, {
    generateReport: true
  });

  await page.goto('https://example.com');

  // 使用自然语言描述操作
  await agent.aiTap('页面右上角的登录按钮');
  await agent.aiInput('用户名输入框', { value: 'test@example.com' });
  await agent.aiInput('密码输入框', { value: 'password123' });
  await agent.aiTap('提交按钮');

  // 等待页面跳转
  await agent.aiWaitFor('页面完成跳转,显示用户主页');

  await browser.close();
}

main();
```

### 3. 在 Playwright Test 中使用

```typescript
// tests/example.spec.ts
import { test, expect } from '@playwright/test';
import { PlaywrightAgent } from '@midscene/web/playwright';

test('用户登录测试', async ({ page }) => {
  // 创建 Agent
  const agent = await PlaywrightAgent.create(page, {
    generateReport: true,
    groupName: '登录测试'
  });

  // 导航
  await page.goto('https://example.com');

  // 执行登录
  await agent.aiAction('完成用户登录流程');

  // 验证
  const username = await agent.aiQuery<string>('string, 获取当前登录用户名');
  expect(username).toBeTruthy();
});
```

运行:

```bash
npx playwright test
```

---

## Android 自动化

### 1. 环境准备

```bash
# macOS - 安装 ADB
brew install android-platform-tools

# Linux
sudo apt-get install android-tools-adb

# 连接设备
adb devices

# 输出示例:
# List of devices attached
# emulator-5554   device
```

### 2. 基本示例

```typescript
import { AndroidAgent } from '@midscene/android';

async function main() {
  // 1. 创建 Agent (自动连接第一个设备)
  const agent = await AndroidAgent.create({
    generateReport: true
  });

  // 2. 启动应用
  await agent.interface.startApp('com.example.app');

  // 3. 执行自动化任务
  await agent.aiTap('首页的搜索按钮');
  await agent.aiInput('搜索框', { value: 'Midscene' });
  await agent.aiTap('搜索结果中的第一项');

  // 4. 数据提取
  const title = await agent.aiQuery<string>('string, 获取当前页面标题');
  console.log('标题:', title);

  // 5. 断言验证
  await agent.aiAssert('页面显示详情信息');

  // 6. 清理
  await agent.destroy();
}

main();
```

### 3. 指定设备

```typescript
import { AndroidAgent } from '@midscene/android';

const agent = await AndroidAgent.create({
  deviceId: 'emulator-5554',  // 指定设备 ID
  generateReport: true
});
```

### 4. 使用 Android Playground

```bash
# 启动 Android Playground
npx @midscene/android-playground

# 浏览器打开 http://localhost:3000
# 在界面中:
# 1. 选择设备
# 2. 启动应用
# 3. 输入自然语言指令
# 4. 查看执行结果
```

---

## iOS 自动化

### 1. 环境准备

```bash
# 安装 WebDriverAgent (需要 Xcode)
# 参考官方文档: https://midscenejs.com/zh/integrate-with-ios

# 启动 WebDriverAgent
# 在 Xcode 中运行 WebDriverAgent 项目
```

### 2. 基本示例

```typescript
import { IOSAgent } from '@midscene/ios';

async function main() {
  // 1. 创建 Agent
  const agent = await IOSAgent.create({
    deviceId: 'your-device-udid',  // 或使用模拟器 UDID
    wdaPort: 8100,  // WebDriverAgent 端口
    generateReport: true
  });

  // 2. 启动应用
  await agent.interface.launchApp('com.example.app');

  // 3. 执行自动化任务
  await agent.aiTap('登录按钮');
  await agent.aiInput('用户名输入框', { value: 'test' });
  await agent.aiInput('密码输入框', { value: 'password' });
  await agent.aiTap('提交按钮');

  // 4. 等待条件
  await agent.aiWaitFor('显示主页', { timeoutMs: 10000 });

  // 5. 清理
  await agent.destroy();
}

main();
```

### 3. 使用 iOS Playground

```bash
# 启动 iOS Playground
npx @midscene/ios-playground

# 浏览器打开 http://localhost:3000
# 配置设备和应用后使用
```

---

## YAML 脚本使用

### 1. YAML 基本结构

```yaml
# ===== 环境配置 =====
web:
  url: https://example.com
  headless: false
  viewport:
    width: 1920
    height: 1080

# ===== 测试任务列表 =====
tasks:
  - name: "任务名称"
    flow:
      - <指令1>
      - <指令2>
      - ...
```

### 2. 常用指令

#### aiAction - 复杂操作

```yaml
- aiAction: "点击页面右上角的登录按钮,然后输入用户名和密码"
```

#### aiTap - 点击元素

```yaml
- aiTap: "提交按钮"
```

#### aiInput - 输入文本

```yaml
- aiInput:
    locate: "用户名输入框"
    value: "test@example.com"
```

#### aiAssert - 断言验证

```yaml
- aiAssert: "页面显示欢迎信息,包含用户名"
```

#### aiQuery - 数据提取

```yaml
# 提取字符串
- aiQuery:
    demand: "string, 获取页面标题"
    name: title

# 提取数组
- aiQuery:
    demand: "array<string>, 提取所有搜索结果的标题"
    name: searchResults

# 提取对象
- aiQuery:
    demand: "object, 提取用户信息 (包含 name, email, age)"
    name: userInfo
```

#### aiWaitFor - 等待条件

```yaml
- aiWaitFor: "页面完成跳转"
- aiWaitFor: "搜索结果加载完成,至少显示3条结果"
```

#### aiScroll - 滚动页面

```yaml
- aiScroll:
    direction: "down"  # down, up
    distance: 500  # 滚动距离 (像素)
```

#### sleep - 延迟等待

```yaml
- sleep: 2  # 等待 2 秒
```

### 3. 完整示例

```yaml
# 用户登录测试
web:
  url: https://example.com
  headless: false

tasks:
  # ===== 任务 1: 登录流程 =====
  - name: "用户登录-正常流程"
    flow:
      # 1. 点击登录按钮
      - aiAction: "找到页面右上角的登录按钮并点击"

      # 2. 等待表单显示
      - aiWaitFor: "登录表单弹出或页面跳转到登录页"

      # 3. 输入用户名
      - aiInput:
          locate: "用户名输入框"
          value: "test@example.com"

      # 4. 输入密码
      - aiInput:
          locate: "密码输入框"
          value: "password123"

      # 5. 点击提交
      - aiTap: "提交按钮"

      # 6. 等待跳转
      - aiWaitFor: "页面完成跳转"

      # 7. 验证登录成功
      - aiAssert: "页面显示欢迎信息,包含用户名"
      - aiAssert: "页面右上角有退出按钮"

      # 8. 提取用户名
      - aiQuery:
          demand: "string, 获取显示的用户名"
          name: displayedUsername

  # ===== 任务 2: 搜索功能 =====
  - name: "搜索功能测试"
    flow:
      - aiTap: "搜索图标"
      - aiWaitFor: "搜索框弹出"
      - aiInput:
          locate: "搜索输入框"
          value: "Midscene.js"
      - aiAction: "点击搜索按钮并等待结果加载"
      - aiQuery:
          demand: "array<string>, 提取前5条搜索结果的标题"
          name: searchResults
      - aiAssert: "搜索结果不为空,至少有3条结果"
```

### 4. 运行 YAML 脚本

```bash
# 方式 1: 使用 CLI
npx midscene run testcase.yaml

# 方式 2: 批量执行
npx midscene run tests/*.yaml

# 方式 3: 指定输出目录
npx midscene run testcase.yaml --output ./reports

# 方式 4: 在代码中执行
```

在代码中执行:

```typescript
import { Agent } from '@midscene/core';
import fs from 'fs';

async function main() {
  const agent = await createAgent(/* ... */);

  // 读取 YAML 文件
  const yamlContent = fs.readFileSync('testcase.yaml', 'utf-8');

  // 执行 YAML 脚本
  const result = await agent.runYaml(yamlContent);

  console.log('执行结果:', result);
  // result = { title: 'xxx', displayedUsername: 'test', searchResults: [...] }
}
```

---

## 命令行工具

### CLI 使用

#### 基本用法

```bash
# 执行单个 YAML 文件
midscene run testcase.yaml

# 批量执行
midscene run tests/*.yaml

# 指定配置文件
midscene --config config.yaml
```

#### 命令行选项

```bash
Options:
  --config <file>      配置文件路径
  --files <files...>   要执行的 YAML 文件 (支持 glob 模式)
  --output <dir>       报告输出目录 (默认: ./midscene_run)
  --headless           无头模式
  --width <number>     浏览器宽度
  --height <number>    浏览器高度
  --help               显示帮助信息
```

#### 示例

```bash
# 无头模式执行
midscene run testcase.yaml --headless

# 指定浏览器大小
midscene run testcase.yaml --width 1280 --height 720

# 指定输出目录
midscene run testcase.yaml --output ./test-reports
```

### 配置文件

创建 `config.yaml`:

```yaml
# 全局配置
browser:
  headless: false
  viewport:
    width: 1920
    height: 1080

output:
  dir: ./reports
  format: html

cache:
  enabled: true
  strategy: read-write

# 测试文件
files:
  - tests/login.yaml
  - tests/search.yaml
```

使用:

```bash
midscene --config config.yaml
```

---

## Playground 使用

### 1. Web Playground

#### 启动方式

```bash
# 方式 1: 使用 demo 脚本
cd packages/web-integration
pnpm run demo

# 方式 2: 在代码中启动
```

在代码中启动:

```typescript
import { playgroundForAgent } from '@midscene/playground';
import { PlaywrightAgent } from '@midscene/web/playwright';
import { chromium } from 'playwright';

async function main() {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();
  const agent = await PlaywrightAgent.create(page);

  // 启动 Playground
  await playgroundForAgent(agent, {
    port: 3000
  });

  console.log('Playground 已启动: http://localhost:3000');

  // 导航到测试页面
  await page.goto('https://example.com');

  // Playground 会自动连接,可以在浏览器中操作
}

main();
```

#### 使用方式

1. 浏览器打开 `http://localhost:3000`
2. 在左侧输入框输入自然语言指令,例如:
   - "点击登录按钮"
   - "在搜索框中输入 Midscene.js"
   - "提取页面标题"
3. 点击"执行"按钮
4. 查看执行结果和页面截图

### 2. Android Playground

```bash
# 启动
npx @midscene/android-playground

# 浏览器打开 http://localhost:3000
```

使用步骤:
1. 选择设备 (显示已连接的 Android 设备)
2. 启动应用 (输入包名)
3. 输入自然语言指令
4. 查看实时屏幕镜像和执行结果

### 3. iOS Playground

```bash
# 启动
npx @midscene/ios-playground

# 浏览器打开 http://localhost:3000
```

---

## 调试技巧

### 1. 启用调试日志

```bash
# 启用所有调试日志
DEBUG=midscene:* node your-script.js

# 只启用特定模块
DEBUG=midscene:agent node your-script.js
DEBUG=midscene:ai-model node your-script.js
DEBUG=midscene:web node your-script.js
```

### 2. 使用 Playground 调试

Playground 是最直观的调试方式:

```typescript
import { playgroundForAgent } from '@midscene/playground';

const agent = await PlaywrightAgent.create(page);

// 启动 Playground
await playgroundForAgent(agent, {
  port: 3000
});

// 浏览器打开 http://localhost:3000
// 在 Playground 中可视化调试,查看截图和执行结果
```

### 3. 冻结页面上下文

当需要多次查询同一页面时,可以冻结页面上下文:

```typescript
// 冻结当前页面状态
await agent.freezePageContext();

// 多次调用 AI 都使用同一个页面快照
const title = await agent.aiQuery('string, 获取页面标题');
const price = await agent.aiQuery('number, 获取价格');
const description = await agent.aiQuery('string, 获取描述');

// 解冻
await agent.unfreezePageContext();
```

### 4. 验证元素定位

```typescript
// 描述元素并验证定位准确性
const result = await agent.describeElementAtPoint(
  [100, 200],  // 元素中心坐标
  {
    verifyPrompt: true,  // 验证生成的描述是否能定位回原位置
    retryLimit: 3,
    deepThink: true  // 使用深度思考模式
  }
);

console.log('元素描述:', result.prompt);
console.log('验证结果:', result.verifyResult);
```

### 5. 查看生成的报告

每次执行后都会生成详细的 HTML 报告:

```typescript
const agent = await PlaywrightAgent.create(page, {
  generateReport: true,
  autoPrintReportMsg: true  // 自动打印报告路径
});

// 执行任务
await agent.aiAction('执行某个任务');

// 控制台会输出:
// Report: file:///path/to/midscene_run/report_xxx.html
```

打开报告查看:
- 每个步骤的截图
- AI 的思考过程
- 元素定位的可视化
- 执行结果和错误信息

---

## 常见问题

### Q1: Agent 创建失败

**错误信息:** "Cannot find module '@midscene/web'"

**解决方案:**
```bash
# 重新安装依赖
pnpm install

# 重新构建
pnpm run build

# 确认包已正确安装
ls node_modules/@midscene/web
```

### Q2: API 调用失败

**错误信息:** "401 Unauthorized" 或 "API key invalid"

**解决方案:**
1. 检查 `.env` 文件中的 API Key 是否正确
2. 确认 API Key 没有前后空格
3. 测试 API Key 是否有效:

```bash
# 测试 SiliconFlow API
curl -H "Authorization: Bearer YOUR_KEY" \
  https://api.siliconflow.cn/v1/models

# 测试 DeepSeek API
curl -H "Authorization: Bearer YOUR_KEY" \
  https://api.deepseek.com/v1/models
```

### Q3: 元素定位失败

**错误信息:** "Element not found" 或 "Cannot locate element"

**解决方案:**
1. **使用更具体的描述:**
   - ❌ "登录按钮"
   - ✅ "页面右上角的蓝色登录按钮"

2. **添加等待时间:**
```yaml
- aiWaitFor: "页面加载完成"
- aiTap: "登录按钮"
```

3. **检查页面状态:**
   - 确认元素已经渲染
   - 确认元素在可视区域
   - 尝试滚动到元素位置

4. **使用 Playground 调试:**
   - 启动 Playground
   - 查看实时截图
   - 测试不同的描述

### Q4: YAML 解析失败

**错误信息:** "yaml.scanner.ScannerError"

**解决方案:**
1. **检查缩进:** 使用空格,不要用 Tab
2. **检查冒号后的空格:** `key: value` (冒号后必须有空格)
3. **检查引号:** 包含特殊字符的字符串要加引号
4. **使用在线 YAML 验证工具:** https://www.yamllint.com/

### Q5: 浏览器无法启动

**错误信息:** "Executable doesn't exist"

**解决方案:**
```bash
# 重新安装 Playwright 浏览器
npx playwright install chromium --force

# 检查浏览器是否安装成功
npx playwright --version
```

### Q6: 测试执行超时

**错误信息:** "Timeout exceeded"

**解决方案:**
1. **增加超时时间:**
```typescript
await agent.aiAction('复杂操作', {
  timeout: 60000  // 60秒
});
```

2. **拆分复杂操作:**
```yaml
# 不推荐
- aiAction: "完成登录并搜索产品并加入购物车"

# 推荐
- aiAction: "完成登录"
- aiWaitFor: "登录成功"
- aiAction: "搜索产品"
- aiWaitFor: "搜索结果加载完成"
- aiAction: "将第一个产品加入购物车"
```

3. **检查网络:**
   - 确认目标网站可访问
   - 检查代理设置

### Q7: Android 设备连接失败

**错误信息:** "No devices found"

**解决方案:**
```bash
# 检查设备连接
adb devices

# 重启 ADB 服务
adb kill-server
adb start-server

# 检查设备授权
# 在设备上确认"允许 USB 调试"
```

### Q8: 报告无法生成

**错误信息:** "Failed to generate report"

**解决方案:**
1. 确认输出目录有写入权限
2. 检查磁盘空间
3. 查看日志错误信息:
```bash
DEBUG=midscene:* node your-script.js
```

---

## 最佳实践

### 1. 元素描述原则

**具体且唯一:**
- ✅ "页面右上角的蓝色登录按钮"
- ✅ "用户信息卡片中的编辑按钮"
- ❌ "登录"
- ❌ "按钮"

**包含位置信息:**
- ✅ "页面顶部导航栏的搜索框"
- ✅ "左侧边栏的设置图标"

**包含样式信息:**
- ✅ "红色的删除按钮"
- ✅ "带有购物车图标的按钮"

### 2. 断言原则

**明确且可验证:**
- ✅ "页面显示欢迎信息,包含用户名,右上角有退出按钮"
- ✅ "搜索结果不为空,至少显示3条记录"
- ❌ "登录成功"
- ❌ "页面正常"

### 3. 操作顺序

**关键操作后加等待:**
```yaml
- aiTap: "提交按钮"
- aiWaitFor: "页面完成跳转"  # 关键!
- aiAssert: "显示成功信息"
```

**复杂操作拆分为多步:**
```yaml
# 不推荐
- aiAction: "完成整个购买流程"

# 推荐
- aiAction: "选择商品并加入购物车"
- aiWaitFor: "购物车图标显示数量"
- aiAction: "点击购物车并结算"
- aiWaitFor: "跳转到支付页面"
- aiAction: "完成支付"
```

### 4. 数据提取

**明确指定类型:**
```yaml
# 字符串
- aiQuery:
    demand: "string, 获取用户名"
    name: username

# 数字
- aiQuery:
    demand: "number, 获取价格"
    name: price

# 数组
- aiQuery:
    demand: "array<string>, 提取所有商品名称"
    name: productNames

# 对象
- aiQuery:
    demand: "object, 提取用户信息(包含 name, email, phone)"
    name: userInfo
```

---

**文档结束**

© 2025 孙顺达 版权所有
