# 项目配置指南

> **文档版本**: v1.0
> **更新日期**: 2025-11-16
> **适用人员**: 产品经理、开发人员、测试人员

---

## 目录

1. [环境配置](#环境配置)
2. [可配置项详解](#可配置项详解)
3. [模型配置](#模型配置)
4. [浏览器配置](#浏览器配置)
5. [缓存配置](#缓存配置)
6. [报告配置](#报告配置)
7. [二次开发配置](#二次开发配置)

---

## 环境配置

### 基础环境要求

**Node.js 环境:**
- Node.js >= 18.19.0 (推荐 20.9.0)
- pnpm >= 9.3.0 (必须使用 pnpm)

**操作系统:**
- macOS, Linux, Windows

**浏览器引擎:**
- Playwright (推荐) - 已安装 Chromium
- Puppeteer (可选)

### 安装步骤

```bash
# 1. 安装 pnpm
corepack enable

# 2. 安装项目依赖
pnpm install

# 3. 构建所有包
pnpm run build

# 4. 安装 Playwright 浏览器
npx playwright install chromium
```

---

## 可配置项详解

### 1. AI 模型配置 (.env)

项目支持多种 VLM (视觉语言模型),需要在 `.env` 文件中配置:

#### 必需配置

```bash
# ===== 主模型配置 (用于视觉理解和元素定位) =====
# 推荐: SiliconFlow (Qwen2.5-VL)
SILICONFLOW_API_KEY=your_siliconflow_api_key_here
SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICONFLOW_MODEL=Qwen/Qwen2.5-VL

# ===== 规划器配置 (用于任务规划) =====
# 推荐: DeepSeek (deepseek-chat)
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
```

#### 可选配置

```bash
# Anthropic (Claude)
ANTHROPIC_API_KEY=your_anthropic_api_key
ANTHROPIC_MODEL=claude-3-5-sonnet-20241022

# OpenAI
OPENAI_API_KEY=your_openai_api_key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o

# Google Gemini
GEMINI_API_KEY=your_gemini_api_key
GEMINI_MODEL=gemini-2.0-flash-exp

# UI-TARS (本地部署)
UI_TARS_BASE_URL=http://localhost:8000
UI_TARS_MODEL=ui-tars

# 火山引擎 Doubao
ARK_API_KEY=your_ark_api_key
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
ARK_MODEL=doubao-vision-pro-32k
```

#### 模型选择说明

**主模型 (视觉理解):**
- 用于元素定位、页面理解、数据提取
- 必须支持视觉输入 (图片)
- 推荐: Qwen2.5-VL (性价比高)

**规划器模型 (任务规划):**
- 用于 PRD 分析、测试用例生成、复杂任务规划
- 不需要视觉能力
- 推荐: DeepSeek (推理能力强)

**配置方式:**
```bash
# 指定模型
export MIDSCENE_MODEL_NAME=qwen-vl-max
export MIDSCENE_VL_MODE=vlm  # 或 vlm-ui-tars
```

---

### 2. 浏览器配置

#### Playwright 配置

```bash
# 浏览器引擎
BROWSER_ENGINE=playwright  # 或 puppeteer

# 显示模式
HEADLESS=false  # true: 无头模式, false: 显示浏览器窗口

# 窗口大小
VIEWPORT_WIDTH=1920
VIEWPORT_HEIGHT=1080

# 超时设置
OPERATION_TIMEOUT=30000  # 单位: 毫秒 (30秒)
NAVIGATION_TIMEOUT=60000  # 页面导航超时
```

#### 在代码中配置

```typescript
// 方式 1: 创建 Agent 时配置
const agent = await PlaywrightAgent.create(page, {
  // 无配置参数,浏览器由 page 决定
});

// 方式 2: 在 YAML 中配置
// testcase.yaml
web:
  url: https://example.com
  headless: false
  viewport:
    width: 1920
    height: 1080
```

#### 浏览器选择建议

| 场景 | 推荐引擎 | 原因 |
|------|----------|------|
| CI/CD | Playwright + headless | 稳定、快速、资源占用小 |
| 本地开发 | Playwright + 非 headless | 可视化调试 |
| 复杂交互 | Playwright | 功能更丰富 |
| 简单测试 | Puppeteer | 轻量、快速 |

---

### 3. 缓存配置

Midscene 支持缓存 AI 响应,提高重复执行效率。

#### 环境变量配置

```bash
# 启用缓存
MIDSCENE_CACHE=true

# 缓存策略
MIDSCENE_CACHE_STRATEGY=read-write
# 可选值:
# - read-only: 只读缓存 (不写入新缓存)
# - write-only: 只写缓存 (不使用已有缓存)
# - read-write: 读写缓存 (默认)

# 缓存目录
MIDSCENE_CACHE_DIR=./cache
```

#### 代码配置

```typescript
const agent = await PlaywrightAgent.create(page, {
  cache: {
    enabled: true,
    id: 'my-test-cache',  // 缓存标识 (唯一)
    strategy: 'read-write',
    cacheDir: './cache'
  }
});
```

#### 缓存策略说明

**什么会被缓存:**
- AI 规划结果 (aiAction 的执行计划)
- 元素定位结果 (aiLocate 的坐标)
- 数据提取结果 (aiQuery 的返回值)

**缓存匹配规则:**
- 基于 Prompt 相似度
- 基于页面 URL
- 基于操作类型

**适用场景:**
- 重复执行同一测试用例
- CI/CD 环境
- 开发调试阶段

---

### 4. 报告配置

#### 环境变量配置

```bash
# 报告输出目录
MIDSCENE_OUTPUT_DIR=./midscene_run

# 自动生成报告
MIDSCENE_REPORT=true

# 报告格式
MIDSCENE_REPORT_FORMAT=html  # 默认 HTML
```

#### 代码配置

```typescript
const agent = await PlaywrightAgent.create(page, {
  generateReport: true,          // 是否生成报告
  autoPrintReportMsg: true,      // 自动打印报告路径
  groupName: '登录功能测试',     // 报告组名
  groupDescription: '测试用户登录流程',  // 报告描述
  outputDir: './reports'         // 输出目录 (覆盖环境变量)
});
```

#### 报告内容

报告包含:
- **执行时间线** - 每个步骤的时间戳
- **截图** - 每个步骤的页面截图
- **AI 思考过程** - AI 的规划和决策
- **元素定位** - 可视化显示定位的元素
- **执行结果** - 成功/失败状态
- **错误信息** - 失败原因和堆栈

#### 查看报告

```bash
# 报告路径示例
./midscene_run/report_2025-11-16_15-30-45.html

# 在浏览器中打开
open ./midscene_run/report_2025-11-16_15-30-45.html
```

---

### 5. 日志配置

#### 环境变量配置

```bash
# 调试日志
DEBUG=midscene:*  # 启用所有 Midscene 日志

# 分模块启用
DEBUG=midscene:agent  # 只启用 Agent 日志
DEBUG=midscene:ai-model  # 只启用 AI 模型日志
DEBUG=midscene:web  # 只启用 Web 集成日志

# 日志级别
MIDSCENE_LOG_LEVEL=debug  # debug, info, warn, error
```

#### 在代码中使用

```typescript
import debug from 'debug';

const logger = debug('midscene:my-module');
logger('This is a debug message');
```

---

### 6. 代理配置 (可选)

如果需要通过代理访问 AI API:

```bash
# HTTP 代理
HTTP_PROXY=http://proxy.example.com:8080

# HTTPS 代理
HTTPS_PROXY=http://proxy.example.com:8080

# 不使用代理的域名
NO_PROXY=localhost,127.0.0.1
```

---

## 二次开发配置

### 1. 添加自定义模型

编辑 `packages/core/src/ai-model/service-caller/index.ts`:

```typescript
export async function callAI(
  messages: ChatMessage[],
  config: ModelConfig
): Promise<AIResponse> {
  const provider = config.provider;

  switch (provider) {
    case 'openai':
      return callOpenAI(messages, config);
    case 'my-custom-provider':  // 添加新提供商
      return callMyCustomProvider(messages, config);
    default:
      throw new Error(`Unknown provider: ${provider}`);
  }
}
```

### 2. 自定义动作空间

扩展设备的动作空间:

```typescript
// 创建自定义设备类
class CustomWebPage extends WebPage {
  async actionSpace(): Promise<DeviceAction[]> {
    const baseActions = await super.actionSpace();

    return [
      ...baseActions,
      {
        type: 'CustomAction',
        execute: async (param) => {
          // 自定义动作实现
          console.log('执行自定义动作:', param);
        }
      }
    ];
  }
}
```

### 3. 自定义 Prompt 模板

编辑 `packages/core/src/ai-model/prompt/` 下的文件:

- `llm-locator.ts` - 元素定位 Prompt
- `extraction.ts` - 数据提取 Prompt
- `assertion.ts` - 断言验证 Prompt
- `planning.ts` - 任务规划 Prompt

示例:

```typescript
// packages/core/src/ai-model/prompt/llm-locator.ts
export function systemPromptToLocateElement(prompt: string): string {
  return `你是一个专业的 UI 元素定位专家。

请根据用户描述定位页面上的元素: "${prompt}"

返回格式: (x, y, width, height)
`;
}
```

### 4. 自定义报告格式

编辑 `packages/core/src/utils.ts` 中的报告生成逻辑:

```typescript
export function reportHTMLContent(dumpData: string): string {
  // 自定义报告 HTML
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <title>我的自定义报告</title>
        <style>
          /* 自定义样式 */
        </style>
      </head>
      <body>
        <div id="custom-report">
          <!-- 自定义报告内容 -->
        </div>
        <script>
          window.__REPORT_DATA__ = ${dumpData};
          // 自定义 JavaScript
        </script>
      </body>
    </html>
  `;
}
```

---

## 配置文件示例

### 完整的 .env 配置

```bash
# ===== AI 模型配置 =====
# 主模型
SILICONFLOW_API_KEY=sk-xxxxxx
SILICONFLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICONFLOW_MODEL=Qwen/Qwen2.5-VL

# 规划器
DEEPSEEK_API_KEY=sk-xxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat

# 模型选择
MIDSCENE_MODEL_NAME=qwen-vl-max
MIDSCENE_VL_MODE=vlm

# ===== 浏览器配置 =====
BROWSER_ENGINE=playwright
HEADLESS=false
VIEWPORT_WIDTH=1920
VIEWPORT_HEIGHT=1080
OPERATION_TIMEOUT=30000

# ===== 缓存配置 =====
MIDSCENE_CACHE=true
MIDSCENE_CACHE_STRATEGY=read-write
MIDSCENE_CACHE_DIR=./cache

# ===== 报告配置 =====
MIDSCENE_OUTPUT_DIR=./midscene_run
MIDSCENE_REPORT=true

# ===== 调试配置 =====
DEBUG=midscene:*
MIDSCENE_LOG_LEVEL=debug

# ===== 代理配置 (可选) =====
# HTTP_PROXY=http://proxy.example.com:8080
# HTTPS_PROXY=http://proxy.example.com:8080
```

---

## 常见配置问题

### Q1: API Key 配置后不生效?

**A:** 确保:
1. `.env` 文件在项目根目录
2. API Key 没有前后空格
3. 重启应用使配置生效
4. 检查环境变量是否正确加载:
```bash
node -e "require('dotenv').config(); console.log(process.env.SILICONFLOW_API_KEY)"
```

### Q2: 缓存没有生效?

**A:** 检查:
1. `MIDSCENE_CACHE=true` 已设置
2. 缓存目录有写入权限
3. 缓存 ID 唯一且一致
4. Prompt 相似度是否匹配

### Q3: 报告无法生成?

**A:** 确认:
1. `generateReport: true` 已设置
2. 输出目录有写入权限
3. 检查磁盘空间
4. 查看日志错误信息

### Q4: 浏览器启动失败?

**A:** 尝试:
1. 重新安装浏览器: `npx playwright install chromium --force`
2. 检查浏览器可执行文件路径
3. 尝试 headless 模式
4. 检查系统依赖 (Linux 需要额外库)

---

## 配置最佳实践

### 1. 开发环境配置

```bash
# 开发环境 - .env.development
HEADLESS=false  # 显示浏览器窗口
DEBUG=midscene:*  # 启用所有日志
MIDSCENE_CACHE=true  # 启用缓存
MIDSCENE_REPORT=true  # 生成报告
```

### 2. 生产环境配置

```bash
# 生产环境 - .env.production
HEADLESS=true  # 无头模式
DEBUG=midscene:error  # 只记录错误
MIDSCENE_CACHE=true  # 启用缓存
MIDSCENE_REPORT=true  # 生成报告
OPERATION_TIMEOUT=60000  # 增加超时时间
```

### 3. CI/CD 配置

```bash
# CI/CD 环境
HEADLESS=true
MIDSCENE_CACHE=true
MIDSCENE_CACHE_STRATEGY=read-only  # 只读缓存
MIDSCENE_REPORT=true
DEBUG=  # 禁用调试日志
```

---

## 配置文件位置

| 配置类型 | 文件路径 | 说明 |
|---------|---------|------|
| 环境变量 | `.env` | 项目根目录 |
| 构建配置 | `rslib.config.ts` | 每个包的根目录 |
| Nx 配置 | `nx.json` | 项目根目录 |
| Workspace 配置 | `pnpm-workspace.yaml` | 项目根目录 |
| Linting 配置 | `biome.json` | 项目根目录 |
| TypeScript 配置 | `tsconfig.json` | 项目根目录和各包 |

---

**文档结束**

© 2025 孙顺达 版权所有
