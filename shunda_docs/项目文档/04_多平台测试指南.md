# 多平台测试指南

> **文档版本**: v1.0
> **更新日期**: 2025-11-16
> **适用人员**: 测试人员、开发人员

---

## 目录

1. [Web 平台测试](#web-平台测试)
2. [Android 平台测试](#android-平台测试)
3. [iOS 平台测试](#ios-平台测试)
4. [跨平台测试策略](#跨平台测试策略)
5. [CI/CD 集成](#cicd-集成)

---

## Web 平台测试

### 1. Playwright 测试

#### 安装和配置

```bash
# 安装 Playwright
npm install --save-dev playwright @midscene/web

# 安装浏览器
npx playwright install chromium
```

#### 基本测试示例

```typescript
// tests/login.spec.ts
import { test, expect } from '@playwright/test';
import { PlaywrightAgent } from '@midscene/web/playwright';

test.describe('用户登录功能', () => {
  test('正常登录流程', async ({ page }) => {
    // 创建 Agent
    const agent = await PlaywrightAgent.create(page, {
      generateReport: true,
      groupName: '登录测试'
    });

    // 导航到登录页
    await page.goto('https://example.com/login');

    // 执行登录
    await agent.aiInput('用户名输入框', { value: 'test@example.com' });
    await agent.aiInput('密码输入框', { value: 'password123' });
    await agent.aiTap('登录按钮');

    // 等待跳转
    await agent.aiWaitFor('页面完成跳转');

    // 验证登录成功
    await agent.aiAssert('页面显示欢迎信息,包含用户名');

    // 提取用户名
    const username = await agent.aiQuery<string>('string, 获取当前登录用户名');
    expect(username).toBe('test');
  });

  test('错误密码提示', async ({ page }) => {
    const agent = await PlaywrightAgent.create(page);

    await page.goto('https://example.com/login');

    await agent.aiInput('用户名输入框', { value: 'test@example.com' });
    await agent.aiInput('密码输入框', { value: 'wrongpassword' });
    await agent.aiTap('登录按钮');

    // 验证错误提示
    await agent.aiAssert('页面显示密码错误提示');
  });
});
```

#### 运行测试

```bash
# 运行所有测试
npx playwright test

# 运行指定文件
npx playwright test tests/login.spec.ts

# UI 模式
npx playwright test --ui

# 调试模式
npx playwright test --debug

# 生成报告
npx playwright test --reporter=html
```

#### Playwright 配置

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  timeout: 60000,  // 60秒超时
  fullyParallel: true,  // 并行执行
  retries: 2,  // 失败重试2次
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results.json' }]
  ],
  use: {
    baseURL: 'https://example.com',
    trace: 'retain-on-failure',  // 失败时保留 trace
    screenshot: 'only-on-failure',  // 失败时截图
    video: 'retain-on-failure'  // 失败时录制视频
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] }
    }
  ]
});
```

---

### 2. Puppeteer 测试

#### 安装和配置

```bash
npm install --save-dev puppeteer @midscene/web
```

#### 基本测试示例

```typescript
// tests/search.test.ts
import puppeteer from 'puppeteer';
import { PuppeteerAgent } from '@midscene/web/puppeteer';

describe('搜索功能', () => {
  let browser: puppeteer.Browser;
  let page: puppeteer.Page;
  let agent: PuppeteerAgent;

  beforeAll(async () => {
    browser = await puppeteer.launch({ headless: false });
    page = await browser.newPage();
    agent = await PuppeteerAgent.create(page, {
      generateReport: true
    });
  });

  afterAll(async () => {
    await browser.close();
  });

  test('搜索 Midscene.js', async () => {
    await page.goto('https://www.bing.com');

    // 输入搜索关键词
    await agent.aiInput('搜索框', { value: 'Midscene.js' });

    // 点击搜索按钮
    await agent.aiTap('搜索按钮');

    // 等待结果加载
    await agent.aiWaitFor('搜索结果加载完成');

    // 提取搜索结果
    const results = await agent.aiQuery<string[]>(
      'array<string>, 提取前5条搜索结果的标题'
    );

    expect(results.length).toBeGreaterThanOrEqual(3);
  });
});
```

#### Jest 配置

```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  testTimeout: 60000,  // 60秒超时
  setupFilesAfterEnv: ['./tests/setup.ts'],
  reporters: [
    'default',
    ['jest-junit', {
      outputDirectory: './test-results',
      outputName: 'junit.xml'
    }]
  ]
};
```

---

### 3. 端到端测试示例

#### 复杂业务流程测试

```typescript
// tests/e2e/purchase-flow.spec.ts
import { test, expect } from '@playwright/test';
import { PlaywrightAgent } from '@midscene/web/playwright';

test('完整购买流程', async ({ page }) => {
  const agent = await PlaywrightAgent.create(page, {
    generateReport: true,
    groupName: 'E2E - 购买流程'
  });

  // 1. 登录
  await page.goto('https://example.com');
  await agent.aiAction('完成用户登录');
  await agent.aiWaitFor('登录成功,显示用户主页');

  // 2. 搜索商品
  await agent.aiInput('搜索框', { value: '手机' });
  await agent.aiAction('点击搜索并等待结果加载');

  // 3. 选择商品
  await agent.aiAction('点击第一个搜索结果');
  await agent.aiWaitFor('商品详情页加载完成');

  // 4. 加入购物车
  const productName = await agent.aiQuery<string>('string, 获取商品名称');
  await agent.aiTap('加入购物车按钮');
  await agent.aiWaitFor('购物车图标显示数量增加');

  // 5. 进入购物车
  await agent.aiTap('购物车图标');
  await agent.aiWaitFor('购物车页面加载完成');

  // 6. 验证商品在购物车中
  await agent.aiAssert(`购物车中包含商品 "${productName}"`);

  // 7. 结算
  await agent.aiTap('去结算按钮');
  await agent.aiWaitFor('跳转到订单确认页面');

  // 8. 确认订单
  await agent.aiAssert('显示收货地址和商品信息');
  await agent.aiTap('提交订单按钮');

  // 9. 支付
  await agent.aiWaitFor('跳转到支付页面');
  await agent.aiAction('选择支付宝支付并完成支付');

  // 10. 验证订单创建成功
  await agent.aiWaitFor('显示支付成功页面');
  const orderNumber = await agent.aiQuery<string>('string, 获取订单编号');

  expect(orderNumber).toBeTruthy();
  console.log('订单编号:', orderNumber);
});
```

---

## Android 平台测试

### 1. 环境准备

#### 安装 ADB

```bash
# macOS
brew install android-platform-tools

# Linux (Ubuntu/Debian)
sudo apt-get install android-tools-adb

# 验证安装
adb version
```

#### 连接设备

```bash
# 启用 USB 调试 (在设备上)
# 设置 -> 关于手机 -> 连续点击版本号7次 -> 开发者选项 -> USB调试

# 连接设备并授权
adb devices

# 输出:
# List of devices attached
# ABC123456     device
```

#### 安装应用

```bash
# 安装 APK
adb install app.apk

# 查看已安装应用
adb shell pm list packages | grep com.example
```

---

### 2. 基本测试示例

```typescript
// tests/android/login.test.ts
import { AndroidAgent } from '@midscene/android';

describe('Android - 登录功能', () => {
  let agent: AndroidAgent;

  beforeAll(async () => {
    // 创建 Agent
    agent = await AndroidAgent.create({
      generateReport: true,
      groupName: 'Android 登录测试'
    });

    // 启动应用
    await agent.interface.startApp('com.example.app');

    // 等待应用启动
    await new Promise(resolve => setTimeout(resolve, 2000));
  });

  afterAll(async () => {
    await agent.destroy();
  });

  test('正常登录流程', async () => {
    // 点击登录按钮
    await agent.aiTap('登录按钮');

    // 输入用户名
    await agent.aiInput('用户名输入框', { value: 'test@example.com' });

    // 输入密码
    await agent.aiInput('密码输入框', { value: 'password123' });

    // 点击提交
    await agent.aiTap('登录按钮');

    // 等待登录成功
    await agent.aiWaitFor('显示主页', { timeoutMs: 10000 });

    // 验证登录成功
    await agent.aiAssert('页面显示用户信息');

    // 提取用户名
    const username = await agent.aiQuery<string>('string, 获取显示的用户名');
    expect(username).toBe('test');
  });

  test('滚动和定位', async () => {
    // 滚动到底部
    await agent.aiScroll({ direction: 'down', distance: 500 });

    // 等待内容加载
    await agent.aiWaitFor('新内容加载完成');

    // 点击底部的按钮
    await agent.aiTap('页面底部的设置按钮');
  });
});
```

---

### 3. Android 设备操作

```typescript
import { AndroidAgent } from '@midscene/android';

const agent = await AndroidAgent.create();

// 启动应用
await agent.interface.startApp('com.example.app');

// 停止应用
await agent.interface.stopApp('com.example.app');

// 清除应用数据
await agent.interface.clearAppData('com.example.app');

// 返回上一页
await agent.interface.pressBack();

// 按 Home 键
await agent.interface.pressHome();

// 截图
const screenshot = await agent.interface.screenshotBase64();

// 获取屏幕尺寸
const size = await agent.interface.size();
console.log('屏幕尺寸:', size);
```

---

### 4. Android Playground 测试

```bash
# 启动 Android Playground
npx @midscene/android-playground

# 浏览器打开 http://localhost:3000
```

在 Playground 中:
1. 选择设备
2. 启动应用
3. 输入自然语言指令进行测试
4. 查看实时屏幕镜像和执行结果

---

## iOS 平台测试

### 1. 环境准备

#### 安装 WebDriverAgent

```bash
# 克隆 WebDriverAgent
git clone https://github.com/appium/WebDriverAgent.git
cd WebDriverAgent

# 安装依赖
./Scripts/bootstrap.sh

# 在 Xcode 中打开项目
open WebDriverAgent.xcodeproj

# 配置签名并运行 WebDriverAgentRunner target
```

#### 获取设备 UDID

```bash
# 查看已连接的设备
xcrun xctrace list devices

# 或使用 idevice
brew install libimobiledevice
idevice_id -l
```

---

### 2. 基本测试示例

```typescript
// tests/ios/login.test.ts
import { IOSAgent } from '@midscene/ios';

describe('iOS - 登录功能', () => {
  let agent: IOSAgent;

  beforeAll(async () => {
    // 创建 Agent
    agent = await IOSAgent.create({
      deviceId: 'your-device-udid',  // 真机 UDID 或模拟器 UDID
      wdaPort: 8100,  // WebDriverAgent 端口
      generateReport: true,
      groupName: 'iOS 登录测试'
    });

    // 启动应用
    await agent.interface.launchApp('com.example.app');

    // 等待应用启动
    await new Promise(resolve => setTimeout(resolve, 2000));
  });

  afterAll(async () => {
    await agent.destroy();
  });

  test('正常登录流程', async () => {
    // 点击登录按钮
    await agent.aiTap('登录');

    // 输入用户名
    await agent.aiInput('用户名', { value: 'test@example.com' });

    // 输入密码
    await agent.aiInput('密码', { value: 'password123' });

    // 点击登录
    await agent.aiTap('登录按钮');

    // 等待登录成功
    await agent.aiWaitFor('显示主页', { timeoutMs: 10000 });

    // 验证登录成功
    await agent.aiAssert('页面显示用户信息');
  });

  test('滑动和手势', async () => {
    // 向左滑动
    await agent.interface.swipe({ from: [300, 500], to: [100, 500] });

    // 长按
    await agent.interface.longPress([200, 300], 2000);
  });
});
```

---

### 3. iOS 设备操作

```typescript
import { IOSAgent } from '@midscene/ios';

const agent = await IOSAgent.create({
  deviceId: 'your-device-udid',
  wdaPort: 8100
});

// 启动应用
await agent.interface.launchApp('com.example.app');

// 终止应用
await agent.interface.terminateApp('com.example.app');

// 返回主屏幕
await agent.interface.pressHomeButton();

// 截图
const screenshot = await agent.interface.screenshotBase64();

// 获取屏幕尺寸
const size = await agent.interface.size();
```

---

## 跨平台测试策略

### 1. 统一的测试用例

使用 YAML 编写跨平台测试用例:

```yaml
# tests/cross-platform/login.yaml

# Web 配置
web:
  url: https://example.com/login
  headless: false

# Android 配置
android:
  package: com.example.app
  activity: .MainActivity

# iOS 配置
ios:
  bundleId: com.example.app

# 通用测试任务
tasks:
  - name: "登录流程测试"
    flow:
      - aiInput:
          locate: "用户名输入框"
          value: "test@example.com"
      - aiInput:
          locate: "密码输入框"
          value: "password123"
      - aiTap: "登录按钮"
      - aiWaitFor: "登录成功,显示主页"
      - aiAssert: "页面显示用户信息"
```

### 2. 平台特定测试

```typescript
// tests/cross-platform/login.test.ts
import { PlaywrightAgent } from '@midscene/web/playwright';
import { AndroidAgent } from '@midscene/android';
import { IOSAgent } from '@midscene/ios';

describe('跨平台登录测试', () => {
  describe('Web 平台', () => {
    test('登录', async () => {
      // Web 测试逻辑
    });
  });

  describe('Android 平台', () => {
    test('登录', async () => {
      // Android 测试逻辑
    });
  });

  describe('iOS 平台', () => {
    test('登录', async () => {
      // iOS 测试逻辑
    });
  });
});
```

---

## CI/CD 集成

### 1. GitHub Actions

```yaml
# .github/workflows/test.yml
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  web-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          corepack enable
          pnpm install

      - name: Build
        run: pnpm run build

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Run Web tests
        run: npx playwright test
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          HEADLESS: true
          MIDSCENE_CACHE: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results/

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/

  android-test:
    runs-on: macos-latest  # macOS for Android emulator
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install dependencies
        run: |
          corepack enable
          pnpm install

      - name: Build
        run: pnpm run build

      - name: Start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: |
            adb devices
            pnpm run test:android
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
```

### 2. GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test

build:
  stage: build
  image: node:20
  script:
    - corepack enable
    - pnpm install
    - pnpm run build
  artifacts:
    paths:
      - dist/
      - node_modules/

web-test:
  stage: test
  image: mcr.microsoft.com/playwright:latest
  dependencies:
    - build
  script:
    - npx playwright install chromium
    - npx playwright test
  variables:
    HEADLESS: "true"
    MIDSCENE_CACHE: "true"
  artifacts:
    when: always
    paths:
      - test-results/
      - playwright-report/
```

---

## 测试最佳实践

### 1. 测试组织

```
tests/
├── e2e/                 # 端到端测试
│   ├── web/
│   ├── android/
│   └── ios/
├── integration/         # 集成测试
├── unit/                # 单元测试
└── fixtures/            # 测试数据和辅助函数
```

### 2. 数据驱动测试

```typescript
const testCases = [
  { username: 'test1@example.com', password: 'pass1', expected: 'test1' },
  { username: 'test2@example.com', password: 'pass2', expected: 'test2' }
];

for (const testCase of testCases) {
  test(`登录 - ${testCase.username}`, async ({ page }) => {
    const agent = await PlaywrightAgent.create(page);

    await agent.aiInput('用户名', { value: testCase.username });
    await agent.aiInput('密码', { value: testCase.password });
    await agent.aiTap('登录');

    const username = await agent.aiQuery<string>('string, 获取用户名');
    expect(username).toBe(testCase.expected);
  });
}
```

### 3. Page Object 模式

```typescript
// pages/LoginPage.ts
export class LoginPage {
  constructor(private agent: Agent) {}

  async login(username: string, password: string) {
    await this.agent.aiInput('用户名输入框', { value: username });
    await this.agent.aiInput('密码输入框', { value: password });
    await this.agent.aiTap('登录按钮');
    await this.agent.aiWaitFor('登录成功');
  }

  async getUsername(): Promise<string> {
    return this.agent.aiQuery<string>('string, 获取当前用户名');
  }
}

// 使用
const loginPage = new LoginPage(agent);
await loginPage.login('test@example.com', 'password123');
const username = await loginPage.getUsername();
```

---

**文档结束**

© 2025 孙顺达 版权所有
