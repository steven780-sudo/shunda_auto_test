# 数字浙江统一社会信用代码查询 - 测试用例说明

## 📁 文件清单

1. **数字浙江信用代码查询.yaml** - YAML 配置文件（CLI 执行）
2. **数字浙江信用代码查询.ts** - TypeScript 脚本（编程执行）
3. 本说明文档

---

## 🎯 测试目标

**原始需求:**
> 在百度的输入框中输入"数字浙江"，点击百度一下，在出现的页面中找到数字浙江百度百科的标签，点击进入，在页面中查找统一社会信用代码，如果找不到就页面向下滚动，直到找到统一社会信用代码，然后截图复制，生成测试报告，报告中需要有截图和统一社会信用代码。

**优化后的测试流程:**
1. ✅ 百度搜索"数字浙江"
2. ✅ 智能识别并点击百度百科链接
3. ✅ 自动滚动查找"统一社会信用代码"（最多滚动5次）
4. ✅ AI 提取信用代码数据
5. ✅ 自动截图保存
6. ✅ 生成 HTML + JSON 双格式报告
7. ✅ 报告包含完整截图和执行时间线

---

## 📊 相比原始需求的优化点

### 1. **智能滚动逻辑**
- ❌ 原始: "如果找不到就页面向下滚动"（无限循环风险）
- ✅ 优化: 最多滚动5次，每次滚动后智能判断是否找到目标

### 2. **数据提取方式**
- ❌ 原始: "截图复制"（需要手动处理）
- ✅ 优化: AI 自动提取信用代码文本，同时保存截图

### 3. **报告质量**
- ❌ 原始: 简单报告
- ✅ 优化:
  - HTML 可视化报告（Midscene 自动生成）
  - JSON 结构化数据报告
  - 包含每个步骤的截图和时间线
  - 完整的执行日志和错误追踪

### 4. **错误处理**
- ❌ 原始: 无错误处理
- ✅ 优化:
  - 每个步骤都有独立的错误捕获
  - 失败步骤不会导致整个测试崩溃
  - 详细的错误信息记录

### 5. **可维护性**
- ❌ 原始: 一次性脚本
- ✅ 优化:
  - 模块化设计，每个步骤独立
  - 可配置参数（最大滚动次数、超时时间）
  - 可复用的测试类

---

## 🚀 执行方式

### 方式 1: 使用 YAML 文件（推荐快速测试）

```bash
# 进入项目根目录
cd /Users/sunshunda/Desktop/browser/auto_test

# 执行 YAML 测试用例
npx midscene run 数字浙江信用代码查询.yaml

# 或批量执行多个测试
npx midscene run tests/*.yaml
```

**优点:**
- ✅ 无需编写代码
- ✅ 声明式配置，易于理解
- ✅ 适合非开发人员使用

### 方式 2: 使用 TypeScript 脚本（推荐集成测试）

```bash
# 进入项目根目录
cd /Users/sunshunda/Desktop/browser/auto_test

# 直接执行 TypeScript 文件
npx tsx 数字浙江信用代码查询.ts

# 或使用 ts-node
npx ts-node 数字浙江信用代码查询.ts
```

**优点:**
- ✅ 完整的错误处理
- ✅ 可自定义报告格式
- ✅ 易于集成到 CI/CD 流程
- ✅ 可编程控制每个步骤

### 方式 3: 在 Playground 中测试（推荐开发调试）

1. 确保 Playground 服务已启动:
   ```bash
   # Frontend: http://localhost:3000
   # Backend:  http://localhost:5870
   ```

2. 在 Playground 界面中输入以下指令逐步执行:
   ```
   在百度输入框输入"数字浙江"，点击百度一下
   ```
   ```
   点击数字浙江百度百科链接
   ```
   ```
   向下滚动直到找到统一社会信用代码
   ```
   ```
   提取统一社会信用代码的值
   ```

**优点:**
- ✅ 可视化调试
- ✅ 实时查看 AI 推理过程
- ✅ 适合开发和调试阶段

---

## 📄 测试报告位置

执行测试后，报告会自动生成在以下位置:

```
/Users/sunshunda/Desktop/browser/auto_test/midscene_run/
├── screenshots/                      # 截图目录
│   └── 数字浙江_2025-01-13.png      # 全页截图
├── reports/                          # JSON 报告目录
│   └── 数字浙江测试结果_2025-01-13.json
└── report_xxxxx.html                 # Midscene HTML 报告（包含完整时间线）
```

### HTML 报告内容:
- 📸 每个步骤的截图
- 🕐 完整的执行时间线
- 🤖 AI 模型的推理过程
- 🎯 元素定位的可视化标注
- ✅/❌ 每个步骤的执行结果

### JSON 报告内容:
```json
{
  "success": true,
  "creditCode": "91330000MA28A6FU6N",
  "screenshotPath": "./midscene_run/screenshots/数字浙江_xxx.png",
  "timestamp": "2025-01-13T05:00:00.000Z",
  "pageUrl": "https://baike.baidu.com/item/数字浙江",
  "steps": [
    {
      "stepName": "初始化浏览器",
      "status": "success",
      "message": "浏览器和 Agent 初始化成功",
      "timestamp": "2025-01-13T05:00:00.000Z"
    },
    // ... 其他步骤
  ]
}
```

---

## 🔧 配置参数

### TypeScript 版本可配置项:

```typescript
// 在 数字浙江信用代码查询.ts 中修改

// 1. 最大滚动次数 (第26行)
private maxScrollAttempts = 5;  // 改为 10 可以滚动更多次

// 2. 浏览器模式 (第45行)
headless: false,  // 改为 true 启用无头模式

// 3. 每次滚动距离 (第211行)
distance: 800,  // 改为 500 或 1000 调整滚动幅度

// 4. 等待时间 (第215行)
await this.page.waitForTimeout(1500);  // 调整滚动后等待时间

// 5. 启用缓存 (第68行)
cache: {
  enabled: false,  // 改为 true 启用缓存（加速重复测试）
}
```

---

## 🐛 常见问题处理

### 1. 问题: 找不到百度百科链接
**原因:** 百度搜索结果变化，百科链接位置不同
**解决方案:**
```typescript
// 在 step2_OpenBaiduBaike() 中修改定位词
await this.agent.aiTap(
  '数字浙江百度百科链接 或 包含百科字样的链接 或 第一个搜索结果'
);
```

### 2. 问题: 滚动5次后仍未找到信用代码
**原因:** 页面结构变化或信用代码在折叠区域内
**解决方案:**
```typescript
// 增加滚动次数
private maxScrollAttempts = 10;

// 或先展开折叠区域
await this.agent.aiTap('展开全部信息 或 查看更多');
```

### 3. 问题: AI 提取的信用代码格式不正确
**原因:** AI 误识别了其他18位数字
**解决方案:**
```typescript
// 在提取时增加验证逻辑
const creditCodeData = await this.agent.aiQuery<CreditCodeData>(
  `从当前页面中提取"统一社会信用代码"字段对应的值。
  注意: 统一社会信用代码必须是18位字符，格式为大写字母和数字组合。
  请确保提取的是"统一社会信用代码"标签后的值，而不是其他数字。`
);
```

### 4. 问题: 截图不完整
**原因:** 页面过长，fullPage 截图失败
**解决方案:**
```typescript
// 改为截取指定区域
const element = await this.agent.aiLocate('统一社会信用代码区域');
await this.page.screenshot({
  path: screenshotPath,
  clip: {
    x: element.rect[0],
    y: element.rect[1],
    width: element.rect[2] - element.rect[0],
    height: element.rect[3] - element.rect[1],
  }
});
```

---

## 📈 性能优化建议

### 1. 启用缓存（适用于重复测试）
```typescript
cache: {
  enabled: true,
  id: 'digital-zhejiang-credit-code',
  strategy: 'read-write',
}
```

### 2. 减少等待时间
```typescript
// 使用智能等待代替固定延迟
await this.agent.aiWaitFor('页面已加载', { timeoutMs: 5000 });
// 而不是
await this.page.waitForTimeout(3000);
```

### 3. 使用无头模式
```typescript
headless: true,  // 减少资源消耗
```

---

## 🔐 环境变量检查

确保你的 `.env` 文件配置正确:

```bash
# /Users/sunshunda/Desktop/browser/auto_test/.env

MIDSCENE_OPENAI_API_KEY=sk-ubersdpfboocpgtetjkqwkvlwugesaybqrgbyhfytlnyhyge
MIDSCENE_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
MIDSCENE_MODEL_NAME=Qwen/Qwen3-VL-235B-A22B-Thinking

# Planning、VQA、Grounding 都使用同样的配置
MIDSCENE_PLANNING_OPENAI_API_KEY=sk-ubersdpfboocpgtetjkqwkvlwugesaybqrgbyhfytlnyhyge
MIDSCENE_PLANNING_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
MIDSCENE_PLANNING_MODEL_NAME=Qwen/Qwen3-VL-235B-A22B-Thinking

MIDSCENE_VQA_OPENAI_API_KEY=sk-ubersdpfboocpgtetjkqwkvlwugesaybqrgbyhfytlnyhyge
MIDSCENE_VQA_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
MIDSCENE_VQA_MODEL_NAME=Qwen/Qwen3-VL-235B-A22B-Thinking

MIDSCENE_GROUNDING_OPENAI_API_KEY=sk-ubersdpfboocpgtetjkqwkvlwugesaybqrgbyhfytlnyhyge
MIDSCENE_GROUNDING_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
MIDSCENE_GROUNDING_MODEL_NAME=Qwen/Qwen3-VL-235B-A22B-Thinking

MIDSCENE_CACHE=true
MIDSCENE_OUTPUT_DIR=./midscene_run
```

---

## 📚 相关文档

- [Midscene.js 官方文档](https://midscenejs.com)
- [Puppeteer 文档](https://pptr.dev)
- [YAML 脚本语法](https://midscenejs.com/zh/yaml.html)
- [Agent API 参考](https://midscenejs.com/zh/api.html)

---

## 💡 最佳实践

### 1. **先用 Playground 调试，再编写脚本**
   - Playground 可以可视化看到 AI 的推理过程
   - 确认指令可行后再写入脚本

### 2. **使用 aiWaitFor 代替固定延迟**
   ```typescript
   // ❌ 不推荐
   await page.waitForTimeout(3000);

   // ✅ 推荐
   await agent.aiWaitFor('页面加载完成', { timeoutMs: 5000 });
   ```

### 3. **对关键数据进行验证**
   ```typescript
   // 提取后验证格式
   if (creditCode.length !== 18) {
     throw new Error('信用代码格式错误');
   }
   ```

### 4. **保留详细日志**
   ```typescript
   console.log('📊 提取结果:', JSON.stringify(data, null, 2));
   ```

### 5. **使用结构化数据提取**
   ```typescript
   // ✅ 推荐: 明确数据结构
   interface CreditCodeData {
     creditCode: string;
     organizationName?: string;
   }

   const data = await agent.aiQuery<CreditCodeData>(`...`);
   ```

---

## ✨ 总结

这个优化后的测试用例相比原始需求具有以下优势:

1. ✅ **智能化**: AI 自动识别元素、判断页面状态
2. ✅ **健壮性**: 完善的错误处理和重试机制
3. ✅ **可维护性**: 模块化设计，易于修改和扩展
4. ✅ **可视化**: 详细的 HTML 报告，包含截图和时间线
5. ✅ **标准化**: 符合 Midscene 最佳实践
6. ✅ **灵活性**: 支持多种执行方式（YAML / TypeScript / Playground）

**推荐使用顺序:**
1. 🔧 Playground 调试 → 确认流程可行
2. 📝 YAML 快速测试 → 验证基本功能
3. 💻 TypeScript 生产部署 → 集成到 CI/CD

如有任何问题，请查阅 Midscene 官方文档或联系技术支持。
