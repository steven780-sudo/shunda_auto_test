# Midscene.js äº§å“æ¶æ„åˆ†ææŠ¥å‘Š

> **æŠ¥å‘Šç¼–åˆ¶**: äº§å“ç»ç†è§†è§’
> **é¡¹ç›®ç‰ˆæœ¬**: 0.30.8
> **ç¼–åˆ¶æ—¥æœŸ**: 2025-11-13
> **ç”¨é€”**: é¡¹ç›®ç»„å†…éƒ¨åŸ¹è®­ä¸è®²è§£

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ€»è§ˆ](#1-é¡¹ç›®æ€»è§ˆ)
2. [äº§å“æ¶æ„å›¾](#2-äº§å“æ¶æ„å›¾)
3. [äº§å“æµç¨‹å›¾](#3-äº§å“æµç¨‹å›¾)
4. [æ—¶åºå›¾](#4-æ—¶åºå›¾)
5. [æ•°æ®æµå›¾](#5-æ•°æ®æµå›¾)
6. [äº§å“åŠŸèƒ½æ¸…å•](#6-äº§å“åŠŸèƒ½æ¸…å•)
7. [å¯è‡ªå®šä¹‰åŠŸèƒ½æ¸…å•](#7-å¯è‡ªå®šä¹‰åŠŸèƒ½æ¸…å•)
8. [AIæ¨¡å‹æ¶æ„åˆ†æ](#8-aiæ¨¡å‹æ¶æ„åˆ†æ)

---

## 1. é¡¹ç›®æ€»è§ˆ

### 1.1 äº§å“å®šä½

**Midscene.js** æ˜¯ä¸€ä¸ª**åŸºäºè§†è§‰ç†è§£çš„AIé©±åŠ¨è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶**ï¼Œæ ¸å¿ƒåˆ›æ–°ç‚¹åœ¨äºï¼š

- âŒ **ä¸ä¾èµ–ä¼ ç»Ÿçš„ DOM é€‰æ‹©å™¨** (CSS Selector, XPath)
- âœ… **ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°**æ¥å®šä½å’Œæ“ä½œUIå…ƒç´ 
- ğŸ¤– **AIè§†è§‰æ¨¡å‹ç†è§£ç•Œé¢**ï¼Œå®ç°è·¨å¹³å°è‡ªåŠ¨åŒ–

### 1.2 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

| ä¼ ç»Ÿè‡ªåŠ¨åŒ–æµ‹è¯•                  | Midscene.js                   |
| ------------------------------- | ----------------------------- |
| éœ€è¦ç¼–å†™é€‰æ‹©å™¨ `.btn-login`   | ç”¨è‡ªç„¶è¯­è¨€ `"ç‚¹å‡»ç™»å½•æŒ‰é’®"` |
| UIå˜åŒ–å¯¼è‡´è„šæœ¬å¤±æ•ˆ              | AIç†è§£ç•Œé¢è¯­ä¹‰ï¼Œæ›´å¥å£®        |
| éœ€è¦å­¦ä¹ Selenium/Playwright API | ç®€å•çš„ `aiAction()` æ–¹æ³•    |
| ä¸åŒå¹³å°éœ€è¦ä¸åŒå·¥å…·            | ç»Ÿä¸€APIæ”¯æŒWeb/Android/iOS    |
| éš¾ä»¥å¤„ç†Canvasã€å›¾åƒéªŒè¯ç       | AIè§†è§‰æ¨¡å‹ç›´æ¥"çœ‹"ç•Œé¢        |

### 1.3 æŠ€æœ¯ç‰¹æ€§

```
æ ¸å¿ƒæŠ€æœ¯æ ˆ
â”œâ”€â”€ è¯­è¨€: TypeScript
â”œâ”€â”€ æ„å»º: pnpm Monorepo + Nx + Rslib
â”œâ”€â”€ AIæ¨¡å‹: OpenAI, Anthropic, Gemini, Qwen, UI-TARS
â”œâ”€â”€ å¹³å°é›†æˆ: Puppeteer, Playwright, ADB, WebDriverAgent
â””â”€â”€ å¯è§†åŒ–: React + PixiJS
```

### 1.4 æ”¯æŒçš„å¹³å°

- ğŸŒ **Web**: é€šè¿‡ Puppeteer/Playwright
- ğŸ“± **Android**: é€šè¿‡ ADB (Android Debug Bridge)
- ğŸ **iOS**: é€šè¿‡ WebDriverAgent
- ğŸ”Œ **æ‰©å±•æ¨¡å¼**: Chrome Extension æ¡¥æ¥æ¨¡å¼

---

## 2. äº§å“æ¶æ„å›¾

### 2.1 æ•´ä½“æ¶æ„ (å››å±‚æ¶æ„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ (Apps Layer)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Chrome  â”‚  â”‚Playgroundâ”‚  â”‚  Report  â”‚  â”‚   Site   â”‚         â”‚
â”‚  â”‚Extension â”‚  â”‚   UI     â”‚  â”‚  Viewer  â”‚  â”‚   Docs   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¹³å°é›†æˆå±‚ (Platform Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  @midscene/  â”‚  â”‚  @midscene/  â”‚  â”‚  @midscene/  â”‚          â”‚
â”‚  â”‚     web      â”‚  â”‚   android    â”‚  â”‚     ios      â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ Puppeteer    â”‚  â”‚     ADB      â”‚  â”‚ WebDriver    â”‚          â”‚
â”‚  â”‚ Playwright   â”‚  â”‚   Control    â”‚  â”‚   Agent      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒå¼•æ“å±‚ (Core Engine)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   @midscene/core                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Agent   â”‚  â”‚ Insight  â”‚  â”‚ Executor â”‚  â”‚  YAML   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  æ™ºèƒ½ä»£ç†  â”‚  â”‚ æ•°æ®æå–  â”‚  â”‚ ä»»åŠ¡æ‰§è¡Œ  â”‚  â”‚ è„šæœ¬è§£æ â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚           AI Model Integration (å¤šæ¨¡å‹æ”¯æŒ)         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  OpenAI | Anthropic | Gemini | Qwen | UI-TARS     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Device   â”‚  â”‚   Cache    â”‚  â”‚   Logger   â”‚  â”‚  Image  â”‚   â”‚
â”‚  â”‚ Interface  â”‚  â”‚   System   â”‚  â”‚   System   â”‚  â”‚   Proc  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     @midscene/shared                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—å…³ç³»å›¾

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      Agent      â”‚
                      â”‚   (æ™ºèƒ½ä»£ç†)      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ åè°ƒ
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                â†“                â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Insight  â”‚     â”‚ Executor â”‚    â”‚Interface â”‚
       â”‚ (æ´å¯Ÿ)   â”‚     â”‚ (æ‰§è¡Œå™¨) â”‚    â”‚(è®¾å¤‡æ¥å£)â”‚
       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â†“               â†“               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          AI Model Layer                â”‚
        â”‚  (æŒ‰æ„å›¾é€‰æ‹©ä¸åŒæ¨¡å‹)                    â”‚
        â”‚  Intent: Planning | Grounding | VQA    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 åŒ…ä¾èµ–å…³ç³»å›¾

```
åº”ç”¨å±‚ Apps
  â”œâ”€â”€ chrome-extension â”€â”€â†’ @midscene/web
  â”œâ”€â”€ playground â”€â”€â”€â”€â”€â”€â†’ @midscene/visualizer
  â”œâ”€â”€ report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ @midscene/visualizer
  â””â”€â”€ site (æ–‡æ¡£)

å·¥å…·å±‚ Tools
  â”œâ”€â”€ @midscene/cli â”€â”€â”€â”€â”€â”€â”€â†’ @midscene/core + @midscene/web + @midscene/android + @midscene/ios
  â”œâ”€â”€ @midscene/mcp â”€â”€â”€â”€â”€â”€â”€â†’ @midscene/core + @midscene/web
  â””â”€â”€ @midscene/visualizer â”€â†’ @midscene/core

å¹³å°å±‚ Platforms
  â”œâ”€â”€ @midscene/web â”€â”€â”€â”€â”€â”€â”€â†’ @midscene/core + @midscene/playground
  â”œâ”€â”€ @midscene/android â”€â”€â”€â†’ @midscene/core
  â””â”€â”€ @midscene/ios â”€â”€â”€â”€â”€â”€â”€â†’ @midscene/core + @midscene/webdriver

æ ¸å¿ƒå±‚ Core
  â”œâ”€â”€ @midscene/core â”€â”€â”€â”€â”€â”€â†’ @midscene/shared + @midscene/recorder
  â”œâ”€â”€ @midscene/recorder â”€â”€â†’ (standalone)
  â””â”€â”€ @midscene/shared â”€â”€â”€â”€â†’ (foundation)
```

---

## 3. äº§å“æµç¨‹å›¾

### 3.1 ç”¨æˆ·ä½¿ç”¨æµç¨‹ (å…¸å‹Webè‡ªåŠ¨åŒ–åœºæ™¯)

```mermaid
graph TD
    A[å¼€å§‹] --> B{é€‰æ‹©æ¥å…¥æ–¹å¼}
    B -->|ä»£ç æ¥å…¥| C[ç¼–å†™æµ‹è¯•è„šæœ¬]
    B -->|YAMLè„šæœ¬| D[ç¼–å†™YAMLæ–‡ä»¶]
    B -->|Chromeæ‰©å±•| E[å®‰è£…æµè§ˆå™¨æ‰©å±•]

    C --> F[åˆ›å»ºAgentå¯¹è±¡]
    D --> G[CLIæ‰§è¡ŒYAML]
    E --> H[æ‰“å¼€ç›®æ ‡ç½‘é¡µ]

    F --> I[å¯¼èˆªåˆ°ç›®æ ‡é¡µé¢]
    I --> J[è°ƒç”¨AIæ–¹æ³•]

    G --> J
    H --> K[Playgroundæ“ä½œé¢æ¿]
    K --> J

    J --> L{æ“ä½œç±»å‹}
    L -->|äº¤äº’| M[aiTap/aiInput/aiScroll]
    L -->|æ•°æ®æå–| N[aiQuery/aiExtract]
    L -->|æ–­è¨€| O[aiAssert]
    L -->|å¤æ‚ä»»åŠ¡| P[aiAction - AIè‡ªåŠ¨è§„åˆ’]

    M --> Q[æˆªå›¾ + AIè§†è§‰ç†è§£]
    N --> Q
    O --> Q
    P --> Q

    Q --> R[AIæ¨¡å‹å¤„ç†]
    R --> S{å¤„ç†ç±»å‹}
    S -->|å…ƒç´ å®šä½| T[è¿”å›åæ ‡ä½ç½®]
    S -->|æ•°æ®æå–| U[è¿”å›ç»“æ„åŒ–æ•°æ®]
    S -->|ä»»åŠ¡è§„åˆ’| V[è¿”å›æ‰§è¡Œæ­¥éª¤]

    T --> W[æ‰§è¡Œå…·ä½“æ“ä½œ]
    U --> X[ä¿å­˜æ•°æ®ç»“æœ]
    V --> Y[æŒ‰æ­¥éª¤æ‰§è¡Œ]

    W --> Z[ç”ŸæˆæŠ¥å‘Š]
    X --> Z
    Y --> Z

    Z --> AA[å¯è§†åŒ–æŠ¥å‘ŠHTML]
    AA --> AB[ç»“æŸ]
```

### 3.2 æ ¸å¿ƒæ‰§è¡Œæµç¨‹ (Agentå†…éƒ¨)

```mermaid
graph TD
    A[ç”¨æˆ·è°ƒç”¨Agentæ–¹æ³•] --> B{æ–¹æ³•ç±»å‹}

    B -->|aiAction è‡ªåŠ¨è§„åˆ’| C[æ£€æŸ¥ç¼“å­˜]
    C -->|å‘½ä¸­ç¼“å­˜| D[ä½¿ç”¨ç¼“å­˜çš„æ‰§è¡Œè®¡åˆ’]
    C -->|æœªå‘½ä¸­| E[è·å–é¡µé¢ä¸Šä¸‹æ–‡]

    E --> F[è°ƒç”¨Planningæ¨¡å‹]
    F --> G[AIç”Ÿæˆæ‰§è¡Œæ­¥éª¤ YAML]
    G --> H[ç¼“å­˜æ‰§è¡Œè®¡åˆ’]

    D --> I[æ‰§è¡ŒYAMLæ­¥éª¤]
    H --> I

    B -->|aiTap/aiInput äº¤äº’| J[è·å–é¡µé¢æˆªå›¾]
    J --> K[è°ƒç”¨Groundingæ¨¡å‹]
    K --> L[AIå®šä½å…ƒç´ åæ ‡]
    L --> M[æ‰§è¡Œç‚¹å‡»/è¾“å…¥æ“ä½œ]

    B -->|aiQuery æ•°æ®æå–| N[è·å–é¡µé¢æˆªå›¾]
    N --> O[è°ƒç”¨VQAæ¨¡å‹]
    O --> P[AIç†è§£å¹¶æå–æ•°æ®]
    P --> Q[è¿”å›ç»“æ„åŒ–æ•°æ®]

    I --> R[è®°å½•æ‰§è¡Œæ—¥å¿—]
    M --> R
    Q --> R

    R --> S{æ˜¯å¦ç”ŸæˆæŠ¥å‘Š}
    S -->|æ˜¯| T[ç”ŸæˆHTMLæŠ¥å‘Š]
    S -->|å¦| U[è¿”å›ç»“æœ]

    T --> U
```

### 3.3 YAMLè„šæœ¬æ‰§è¡Œæµç¨‹

```mermaid
graph LR
    A[YAMLæ–‡ä»¶] --> B[è§£æYAML]
    B --> C[æå–ä»»åŠ¡åˆ—è¡¨]
    C --> D[éå†æ¯ä¸ªä»»åŠ¡]
    D --> E[éå†flowæ­¥éª¤]
    E --> F{æ­¥éª¤ç±»å‹}

    F -->|aiAction| G[Agent.aiAction]
    F -->|aiTap| H[Agent.aiTap]
    F -->|aiInput| I[Agent.aiInput]
    F -->|aiQuery| J[Agent.aiQuery]
    F -->|aiAssert| K[Agent.aiAssert]

    G --> L[æ‰§è¡Œå¹¶è®°å½•]
    H --> L
    I --> L
    J --> L
    K --> L

    L --> M{æ˜¯å¦æœ‰saveAs}
    M -->|æ˜¯| N[ä¿å­˜ç»“æœåˆ°å˜é‡]
    M -->|å¦| O[ç»§ç»­ä¸‹ä¸€æ­¥]

    N --> O
    O --> P{æ˜¯å¦è¿˜æœ‰æ­¥éª¤}
    P -->|æ˜¯| E
    P -->|å¦| Q[è¿”å›æ‰€æœ‰ä¿å­˜çš„ç»“æœ]
```

---

## 4. æ—¶åºå›¾

### 4.1 Webè‡ªåŠ¨åŒ–å®Œæ•´æ—¶åº

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·ä»£ç 
    participant Agent as Agent
    participant Interface as PuppeteerPage
    participant Insight as Insight
    participant AI as AIæ¨¡å‹æœåŠ¡
    participant Cache as ç¼“å­˜ç³»ç»Ÿ
    participant Report as æŠ¥å‘Šç”Ÿæˆå™¨

    User->>Agent: await agent.aiAction("å®Œæˆç™»å½•")

    Agent->>Cache: æ£€æŸ¥è®¡åˆ’ç¼“å­˜
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>Agent: è¿”å›ç¼“å­˜çš„YAMLæ­¥éª¤
    else ç¼“å­˜æœªå‘½ä¸­
        Agent->>Interface: getContext() è·å–é¡µé¢å¿«ç…§
        Interface->>Interface: æˆªå›¾
        Interface-->>Agent: UIContext {screenshot, size, url}

        Agent->>AI: è°ƒç”¨Planningæ¨¡å‹
        Note over AI: Intent: "planning"<br/>Prompt: "å®Œæˆç™»å½•"<br/>Screenshot: base64
        AI-->>Agent: è¿”å›æ‰§è¡Œæ­¥éª¤YAML

        Agent->>Cache: ä¿å­˜æ‰§è¡Œè®¡åˆ’
    end

    Agent->>Agent: è§£æYAMLæ­¥éª¤

    loop æ¯ä¸ªæ­¥éª¤
        alt æ­¥éª¤éœ€è¦å®šä½å…ƒç´ 
            Agent->>Insight: locate("ç™»å½•æŒ‰é’®")
            Insight->>Interface: getContext()
            Interface-->>Insight: é¡µé¢æˆªå›¾

            Insight->>AI: è°ƒç”¨Groundingæ¨¡å‹
            Note over AI: Intent: "grounding"<br/>Prompt: "ç™»å½•æŒ‰é’®"<br/>Screenshot: base64
            AI-->>Insight: è¿”å›åæ ‡ {rect, center}
            Insight-->>Agent: å…ƒç´ ä½ç½®
        end

        Agent->>Interface: æ‰§è¡Œæ“ä½œ (click/input/scroll)
        Interface-->>Agent: æ“ä½œå®Œæˆ

        Agent->>Report: è®°å½•æ‰§è¡Œæ—¥å¿—
    end

    Agent->>Report: ç”ŸæˆHTMLæŠ¥å‘Š
    Report-->>Agent: æŠ¥å‘Šæ–‡ä»¶è·¯å¾„

    Agent-->>User: è¿”å›æ‰§è¡Œç»“æœ
```

### 4.2 Androidè‡ªåŠ¨åŒ–æ—¶åº

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Agent as AndroidAgent
    participant Device as AndroidDevice
    participant ADB as ADBå®¢æˆ·ç«¯
    participant Phone as Androidè®¾å¤‡
    participant AI as AIæ¨¡å‹

    User->>Agent: åˆ›å»ºAgent
    Agent->>Device: åˆå§‹åŒ–è®¾å¤‡
    Device->>ADB: è¿æ¥è®¾å¤‡
    ADB->>Phone: adb devices
    Phone-->>ADB: è®¾å¤‡åˆ—è¡¨
    ADB-->>Device: è¿æ¥æˆåŠŸ
    Device-->>Agent: åˆå§‹åŒ–å®Œæˆ

    User->>Agent: aiTap("æœç´¢æŒ‰é’®")

    Agent->>Device: getContext()
    Device->>ADB: screencap
    ADB->>Phone: æˆªå›¾å‘½ä»¤
    Phone-->>ADB: æˆªå›¾æ•°æ®
    ADB-->>Device: PNGå›¾åƒ
    Device->>Device: è½¬base64
    Device-->>Agent: UIContext

    Agent->>AI: å®šä½"æœç´¢æŒ‰é’®"
    AI-->>Agent: åæ ‡ (x: 500, y: 200)

    Agent->>Device: æ‰§è¡ŒTapåŠ¨ä½œ
    Device->>ADB: shell input tap 500 200
    ADB->>Phone: æ¨¡æ‹Ÿç‚¹å‡»
    Phone-->>ADB: æ‰§è¡Œå®Œæˆ
    ADB-->>Device: OK
    Device-->>Agent: æ“ä½œæˆåŠŸ

    Agent-->>User: è¿”å›ç»“æœ
```

### 4.3 AIæ¨¡å‹è°ƒç”¨æ—¶åº

```mermaid
sequenceDiagram
    participant Agent as Agent
    participant MCM as ModelConfigManager
    participant Caller as AI Service Caller
    participant Provider as æ¨¡å‹æä¾›å•†<br/>(OpenAI/Anthropic/etc)

    Agent->>MCM: getModelConfig('grounding')
    MCM->>MCM: æ ¹æ®Intenté€‰æ‹©é…ç½®
    MCM-->>Agent: ModelConfig {provider, apiKey, model}

    Agent->>Caller: callAI(messages, config)

    Caller->>Caller: æ ¹æ®provideré€‰æ‹©è°ƒç”¨æ–¹å¼

    alt OpenAI
        Caller->>Provider: POST /v1/chat/completions
    else Anthropic
        Caller->>Provider: POST /v1/messages
    else Gemini
        Caller->>Provider: POST /v1beta/models/xxx:generateContent
    else Qwen
        Caller->>Provider: POST /compatible-mode/v1/chat/completions
    end

    Provider-->>Caller: AIå“åº” (JSON)

    Caller->>Caller: è§£æå“åº”
    Caller->>Caller: æå–å…ƒç´ ä½ç½®/æ•°æ®

    Caller-->>Agent: è¿”å›ç»“æ„åŒ–ç»“æœ
```

---

## 5. æ•°æ®æµå›¾

### 5.1 æ•´ä½“æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥å±‚ (Input)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ç”¨æˆ·ä»£ç       â”‚  â”‚  YAMLè„šæœ¬    â”‚  â”‚  UIæ“ä½œ      â”‚       â”‚
â”‚  â”‚ agent.aiTap()â”‚  â”‚  tasks: []   â”‚  â”‚ (Playground) â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤„ç†å±‚ (Processing)                                           â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent åè°ƒä¸­å¿ƒ                                         â”‚  â”‚
â”‚  â”‚  1. è§£æç”¨æˆ·æ„å›¾                                        â”‚  â”‚
â”‚  â”‚  2. é€‰æ‹©æ‰§è¡Œç­–ç•¥ (ç¼“å­˜/æ–°å»º)                            â”‚  â”‚
â”‚  â”‚  3. è°ƒåº¦å„ä¸ªæ¨¡å—                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â†“                                       â†“            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ TaskCache    â”‚                        â”‚ Insight      â”‚    â”‚
â”‚  â”‚ æ£€æŸ¥ç¼“å­˜      â”‚                        â”‚ AIæ•°æ®æå–    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“                                       â†“            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         TaskExecutor ä»»åŠ¡æ‰§è¡Œå™¨                      â”‚    â”‚
â”‚  â”‚  1. è§„åˆ’ä»»åŠ¡æ­¥éª¤                                     â”‚    â”‚
â”‚  â”‚  2. å®šä½UIå…ƒç´                                        â”‚    â”‚
â”‚  â”‚  3. æ‰§è¡Œæ“ä½œ                                         â”‚    â”‚
â”‚  â”‚  4. æå–æ•°æ®                                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                    â”‚              â”‚
â”‚           â†“                                    â†“              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  AI Model Layer  â”‚              â”‚ Device Interface â”‚      â”‚
â”‚  â”‚  å¤šæ„å›¾æ¨¡å‹è°ƒç”¨   â”‚              â”‚  è®¾å¤‡æ“ä½œæŠ½è±¡     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                  â”‚
            â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨ä¾èµ–å±‚ (External)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  AIæœåŠ¡å•†    â”‚                    â”‚  ç›®æ ‡è®¾å¤‡     â”‚        â”‚
â”‚  â”‚  OpenAI/ç­‰   â”‚                    â”‚ Browser/æ‰‹æœº  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºå±‚ (Output)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  æ‰§è¡Œç»“æœ    â”‚  â”‚  HTMLæŠ¥å‘Š     â”‚  â”‚  ç¼“å­˜æ•°æ®     â”‚       â”‚
â”‚  â”‚  è¿”å›æ•°æ®    â”‚  â”‚  å¯è§†åŒ–å±•ç¤º   â”‚  â”‚  YAMLè®¡åˆ’     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```typescript
// 1. UIä¸Šä¸‹æ–‡ (UIContext) - é¡µé¢å¿«ç…§
{
  screenshotBase64: string,        // é¡µé¢æˆªå›¾ (base64)
  size: { width, height },         // å±å¹•å°ºå¯¸
  url?: string,                    // å½“å‰URL (Web)
  elementTree?: ElementNode[],     // DOMæ ‘ (å¯é€‰)
  extra?: any                      // å¹³å°ç‰¹å®šæ•°æ®
}

// 2. æ‰§è¡Œè®¡åˆ’ (PlanningAction) - AIç”Ÿæˆçš„æ­¥éª¤
{
  type: 'Tap' | 'Input' | 'Scroll' | 'Assert' | ...,
  thought: string,                 // AIçš„æ€è€ƒè¿‡ç¨‹
  param: {
    locate?: {
      prompt: string,              // å…ƒç´ æè¿°
      rect?: Rect,                 // ä½ç½® (æ‰§è¡Œæ—¶å¡«å……)
      center?: [x, y]
    },
    value?: string,                // è¾“å…¥å€¼
    assertion?: string             // æ–­è¨€æ¡ä»¶
  }
}

// 3. å…ƒç´ ä½ç½® (LocateResult)
{
  rect: {                          // çŸ©å½¢è¾¹ç•Œ
    left: number,
    top: number,
    width: number,
    height: number
  },
  center: [x, y]                   // ä¸­å¿ƒåæ ‡
}

// 4. æ‰§è¡Œæ—¥å¿— (ExecutionDump)
{
  groupName: string,               // ä»»åŠ¡ç»„åç§°
  executions: [                    // æ‰§è¡Œè®°å½•åˆ—è¡¨
    {
      title: string,               // ä»»åŠ¡æ ‡é¢˜
      context: UIContext,          // æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡
      tasks: [                     // å­ä»»åŠ¡åˆ—è¡¨
        {
          type: string,            // ä»»åŠ¡ç±»å‹
          status: 'success' | 'fail',
          param: any,              // å‚æ•°
          thought: string,         // AIæ€è€ƒ
          errorMessage?: string    // é”™è¯¯ä¿¡æ¯
        }
      ]
    }
  ]
}

// 5. AIæ¨¡å‹é…ç½® (ModelConfig)
{
  provider: 'openai' | 'anthropic' | 'gemini' | 'qwen',
  apiKey: string,
  baseURL?: string,
  model: string,                   // æ¨¡å‹åç§°
  temperature?: number,
  maxTokens?: number,
  vlMode: boolean,                 // æ˜¯å¦ä¸ºè§†è§‰æ¨¡å‹
  intent: 'VQA' | 'planning' | 'grounding' | 'default'
}
```

### 5.3 æ•°æ®æµè½¬ç¤ºä¾‹ (aiActionæ‰§è¡Œ)

```
ç”¨æˆ·è°ƒç”¨
  â†“
agent.aiAction("å®Œæˆç”¨æˆ·ç™»å½•")
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: æ£€æŸ¥ç¼“å­˜                          â”‚
â”‚  è¾“å…¥: "å®Œæˆç”¨æˆ·ç™»å½•"                     â”‚
â”‚  è¾“å‡º: æœªå‘½ä¸­ç¼“å­˜ â†’ ç»§ç»­                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: è·å–é¡µé¢ä¸Šä¸‹æ–‡                    â”‚
â”‚  è¾“å…¥: pageå¯¹è±¡                          â”‚
â”‚  è¾“å‡º: UIContext {                       â”‚
â”‚    screenshotBase64: "data:image...",   â”‚
â”‚    size: {width: 1920, height: 1080},   â”‚
â”‚    url: "https://example.com/login"     â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: è°ƒç”¨Planningæ¨¡å‹ç”Ÿæˆè®¡åˆ’           â”‚
â”‚  è¾“å…¥: {                                 â”‚
â”‚    prompt: "å®Œæˆç”¨æˆ·ç™»å½•",               â”‚
â”‚    screenshot: UIContext.screenshot,     â”‚
â”‚    intent: "planning"                    â”‚
â”‚  }                                       â”‚
â”‚  â†“ AIå¤„ç†                                â”‚
â”‚  è¾“å‡º: YAMLæ ¼å¼æ‰§è¡Œè®¡åˆ’                   â”‚
â”‚  ```yaml                                 â”‚
â”‚  flow:                                   â”‚
â”‚    - aiTap:                             â”‚
â”‚        locate: "ç”¨æˆ·åè¾“å…¥æ¡†"            â”‚
â”‚    - aiInput:                           â”‚
â”‚        locate: "ç”¨æˆ·åè¾“å…¥æ¡†"            â”‚
â”‚        value: "testuser"                â”‚
â”‚    - aiInput:                           â”‚
â”‚        locate: "å¯†ç è¾“å…¥æ¡†"              â”‚
â”‚        value: "password"                â”‚
â”‚    - aiTap: "ç™»å½•æŒ‰é’®"                  â”‚
â”‚  ```                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4: ä¿å­˜è®¡åˆ’åˆ°ç¼“å­˜                    â”‚
â”‚  è¾“å…¥: {                                 â”‚
â”‚    type: 'plan',                        â”‚
â”‚    prompt: "å®Œæˆç”¨æˆ·ç™»å½•",               â”‚
â”‚    yamlWorkflow: "..."                  â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤5: æ‰§è¡ŒYAMLæ­¥éª¤                      â”‚
â”‚  éå†æ¯ä¸ªæ­¥éª¤:                           â”‚
â”‚    1. aiTap "ç”¨æˆ·åè¾“å…¥æ¡†"               â”‚
â”‚       â†’ è°ƒç”¨Groundingæ¨¡å‹å®šä½            â”‚
â”‚       â†’ è¿”å›åæ ‡ (100, 200)              â”‚
â”‚       â†’ æ‰§è¡Œç‚¹å‡»æ“ä½œ                     â”‚
â”‚    2. aiInput "ç”¨æˆ·åè¾“å…¥æ¡†" = "test"    â”‚
â”‚       â†’ å¤ç”¨ä¸Šä¸€æ­¥å®šä½ç»“æœ               â”‚
â”‚       â†’ æ‰§è¡Œè¾“å…¥æ“ä½œ                     â”‚
â”‚    3. aiInput "å¯†ç è¾“å…¥æ¡†" = "pass"      â”‚
â”‚       â†’ å®šä½æ–°å…ƒç´  (100, 260)            â”‚
â”‚       â†’ æ‰§è¡Œè¾“å…¥æ“ä½œ                     â”‚
â”‚    4. aiTap "ç™»å½•æŒ‰é’®"                   â”‚
â”‚       â†’ å®šä½æŒ‰é’® (150, 320)              â”‚
â”‚       â†’ æ‰§è¡Œç‚¹å‡»æ“ä½œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤6: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š                      â”‚
â”‚  è¾“å…¥: ExecutionDump                     â”‚
â”‚  è¾“å‡º: HTMLæŠ¥å‘Šæ–‡ä»¶                       â”‚
â”‚  è·¯å¾„: ./midscene_run/report_xxx.html   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¿”å›æ‰§è¡Œç»“æœç»™ç”¨æˆ·
```

---

## 6. äº§å“åŠŸèƒ½æ¸…å•

### 6.1 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 6.1.1 äº¤äº’æ“ä½œç±»

| åŠŸèƒ½     | APIæ–¹æ³•                           | è¯´æ˜                     | ä½¿ç”¨åœºæ™¯             |
| -------- | --------------------------------- | ------------------------ | -------------------- |
| æ™ºèƒ½ç‚¹å‡» | `aiTap(prompt)`                 | AIè¯†åˆ«å…ƒç´ å¹¶ç‚¹å‡»         | ç‚¹å‡»æŒ‰é’®ã€é“¾æ¥ã€å›¾æ ‡ |
| æ™ºèƒ½è¾“å…¥ | `aiInput(prompt, {value})`      | AIå®šä½è¾“å…¥æ¡†å¹¶è¾“å…¥       | å¡«å†™è¡¨å•ã€æœç´¢æ¡†     |
| æ™ºèƒ½æ»šåŠ¨ | `aiScroll(direction, distance)` | æ»šåŠ¨é¡µé¢                 | åŠ è½½æ›´å¤šå†…å®¹         |
| è‡ªåŠ¨è§„åˆ’ | `aiAction(task)`                | AIè‡ªåŠ¨è§„åˆ’å¹¶æ‰§è¡Œå¤æ‚ä»»åŠ¡ | "å®Œæˆè´­ç‰©æµç¨‹"       |
| ç­‰å¾…æ¡ä»¶ | `aiWaitFor(condition, timeout)` | ç­‰å¾…æŒ‡å®šæ¡ä»¶æ»¡è¶³         | ç­‰å¾…åŠ è½½å®Œæˆ         |

#### 6.1.2 æ•°æ®æå–ç±»

| åŠŸèƒ½     | APIæ–¹æ³•                 | è¯´æ˜           | ä½¿ç”¨åœºæ™¯           |
| -------- | ----------------------- | -------------- | ------------------ |
| æŸ¥è¯¢æ•°æ® | `aiQuery<T>(demand)`  | æå–å•ä¸ªæ•°æ®   | è·å–ç”¨æˆ·åã€ä»·æ ¼   |
| å¸ƒå°”åˆ¤æ–­ | `aiBoolean(question)` | è¿”å›æ˜¯/å¦      | "æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º" |
| æ‰¹é‡æå– | `aiExtract(schema)`   | æå–ç»“æ„åŒ–æ•°æ® | æå–å•†å“åˆ—è¡¨       |
| å…ƒç´ å®šä½ | `aiLocate(prompt)`    | è·å–å…ƒç´ åæ ‡   | è·å–å…ƒç´ ä½ç½®ä¿¡æ¯   |

#### 6.1.3 è´¨é‡ä¿éšœç±»

| åŠŸèƒ½       | APIæ–¹æ³•                 | è¯´æ˜               | ä½¿ç”¨åœºæ™¯           |
| ---------- | ----------------------- | ------------------ | ------------------ |
| æ–­è¨€éªŒè¯   | `aiAssert(assertion)` | AIåˆ¤æ–­æ–­è¨€æ˜¯å¦æˆç«‹ | "é¡µé¢æ˜¾ç¤ºæˆåŠŸæç¤º" |
| å¯è§†åŒ–æŠ¥å‘Š | è‡ªåŠ¨ç”Ÿæˆ                | HTMLæ ¼å¼æµ‹è¯•æŠ¥å‘Š   | æŸ¥çœ‹æ‰§è¡Œè¿‡ç¨‹       |
| æ‰§è¡Œå›æ”¾   | æŠ¥å‘Šå†…ç½®                | å›æ”¾æµ‹è¯•è¿‡ç¨‹       | è°ƒè¯•å¤±è´¥ç”¨ä¾‹       |
| æˆªå›¾å¯¹æ¯”   | æŠ¥å‘ŠåŠŸèƒ½                | æ¯æ­¥æˆªå›¾å±•ç¤º       | æŸ¥çœ‹UIå˜åŒ–         |

#### 6.1.4 è„šæœ¬åŒ–èƒ½åŠ›

| åŠŸèƒ½     | è¯´æ˜                | ä½¿ç”¨åœºæ™¯        |
| -------- | ------------------- | --------------- |
| YAMLè„šæœ¬ | å£°æ˜å¼è„šæœ¬          | æ‰¹é‡æµ‹è¯•ã€CI/CD |
| CLIå·¥å…·  | `midscene run`    | å‘½ä»¤è¡Œæ‰§è¡Œ      |
| å˜é‡ç³»ç»Ÿ | `saveAs` ä¿å­˜ç»“æœ | æ•°æ®ä¼ é€’        |
| æ¡ä»¶æ‰§è¡Œ | YAMLæ¡ä»¶è¯­æ³•        | åˆ†æ”¯é€»è¾‘        |

### 6.2 å¹³å°æ”¯æŒåŠŸèƒ½

#### 6.2.1 Webå¹³å°

| åŠŸèƒ½           | å®ç°æ–¹å¼                     | è¯´æ˜                |
| -------------- | ---------------------------- | ------------------- |
| Puppeteeré›†æˆ  | `@midscene/web/puppeteer`  | æ”¯æŒChrome/Chromium |
| Playwrighté›†æˆ | `@midscene/web/playwright` | æ”¯æŒå¤šæµè§ˆå™¨        |
| æ¡¥æ¥æ¨¡å¼       | Chrome Extension             | æ— ä»£ç æ“ä½œç°æœ‰é¡µé¢  |
| é™æ€é¡µé¢åˆ†æ   | `StaticPageAgent`          | åˆ†æHTMLæ–‡ä»¶        |

#### 6.2.2 Androidå¹³å°

| åŠŸèƒ½        | å®ç°æ–¹å¼       | è¯´æ˜            |
| ----------- | -------------- | --------------- |
| ADBè®¾å¤‡æ§åˆ¶ | `appium-adb` | è¿æ¥çœŸæœº/æ¨¡æ‹Ÿå™¨ |
| åº”ç”¨å¯åŠ¨    | `startApp()` | å¯åŠ¨æŒ‡å®šåº”ç”¨    |
| è¾“å…¥æ³•æ§åˆ¶  | IMEç­–ç•¥        | æ”¯æŒä¸­æ–‡è¾“å…¥    |
| Playground  | Web UI         | å¯è§†åŒ–æ“ä½œ      |

#### 6.2.3 iOSå¹³å°

| åŠŸèƒ½       | å®ç°æ–¹å¼        | è¯´æ˜          |
| ---------- | --------------- | ------------- |
| æ¨¡æ‹Ÿå™¨æ”¯æŒ | WebDriverAgent  | iOS Simulator |
| çœŸæœºæ”¯æŒ   | WebDriverAgent  | éœ€ç­¾åé…ç½®    |
| åº”ç”¨ç®¡ç†   | `launchApp()` | å¯åŠ¨/å…³é—­åº”ç”¨ |

### 6.3 AIèƒ½åŠ›åŠŸèƒ½

#### 6.3.1 è§†è§‰ç†è§£

| èƒ½åŠ›       | è¯´æ˜                     | æŠ€æœ¯å®ç°     |
| ---------- | ------------------------ | ------------ |
| å…ƒç´ è¯†åˆ«   | è¯†åˆ«æŒ‰é’®ã€è¾“å…¥æ¡†ã€å›¾æ ‡ç­‰ | VLMè§†è§‰æ¨¡å‹  |
| æ–‡å­—ç†è§£   | OCR + è¯­ä¹‰ç†è§£           | å¤šæ¨¡æ€æ¨¡å‹   |
| å¸ƒå±€åˆ†æ   | ç†è§£é¡µé¢ç»“æ„             | ç©ºé—´å…³ç³»æ¨ç† |
| å›¾åƒéªŒè¯ç  | è¯†åˆ«éªŒè¯ç                | è§†è§‰+æ¨ç†    |

#### 6.3.2 æ™ºèƒ½è§„åˆ’

| èƒ½åŠ›         | è¯´æ˜                | æŠ€æœ¯å®ç°    |
| ------------ | ------------------- | ----------- |
| ä»»åŠ¡åˆ†è§£     | å¤æ‚ä»»åŠ¡æ‹†åˆ†ä¸ºæ­¥éª¤  | LLMè§„åˆ’èƒ½åŠ› |
| æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ | ç”ŸæˆYAMLæ‰§è¡Œæµç¨‹    | Promptå·¥ç¨‹  |
| ä¸Šä¸‹æ–‡ç†è§£   | ç†è§£å½“å‰çŠ¶æ€        | å¤šè½®å¯¹è¯    |
| é”™è¯¯æ¢å¤     | å¤±è´¥åé‡è¯•/è°ƒæ•´ç­–ç•¥ | åé¦ˆå¾ªç¯    |

#### 6.3.3 æ•°æ®æå–

| èƒ½åŠ›       | è¯´æ˜              | æŠ€æœ¯å®ç°   |
| ---------- | ----------------- | ---------- |
| ç»“æ„åŒ–æå– | æå–JSON/æ•°ç»„æ•°æ® | Schemaçº¦æŸ |
| è¯­ä¹‰åŒ¹é…   | æ¨¡ç³ŠæŸ¥è¯¢æ•°æ®      | å‘é‡ç›¸ä¼¼åº¦ |
| è¡¨æ ¼æå–   | æå–è¡¨æ ¼æ•°æ®      | è¡¨æ ¼ç†è§£   |
| åŠ¨æ€æ•°æ®   | æå–å˜åŒ–çš„æ•°æ®    | å®æ—¶åˆ†æ   |

### 6.4 å·¥ç¨‹åŒ–åŠŸèƒ½

#### 6.4.1 ç¼“å­˜ç³»ç»Ÿ

| åŠŸèƒ½         | è¯´æ˜                            | é…ç½®                    |
| ------------ | ------------------------------- | ----------------------- |
| æ‰§è¡Œè®¡åˆ’ç¼“å­˜ | ç¼“å­˜aiActionç”Ÿæˆçš„YAML          | `MIDSCENE_CACHE=true` |
| ç¼“å­˜ç­–ç•¥     | read-only/write-only/read-write | `strategy` é€‰é¡¹       |
| ç¼“å­˜å¤±æ•ˆ     | ç›¸ä¼¼åº¦åŒ¹é…                      | è‡ªåŠ¨åˆ¤æ–­                |

#### 6.4.2 æŠ¥å‘Šç³»ç»Ÿ

| åŠŸèƒ½     | è¯´æ˜           | è¾“å‡º           |
| -------- | -------------- | -------------- |
| HTMLæŠ¥å‘Š | å¯è§†åŒ–æŠ¥å‘Š     | `.html` æ–‡ä»¶ |
| JSONæ•°æ® | åŸå§‹æ‰§è¡Œæ•°æ®   | `.json` æ–‡ä»¶ |
| æ—¶é—´çº¿   | æ‰§è¡Œæ—¶é—´çº¿å±•ç¤º | æŠ¥å‘Šå†…ç½®       |
| æˆªå›¾å½’æ¡£ | æ¯æ­¥æˆªå›¾ä¿å­˜   | base64åµŒå…¥     |

#### 6.4.3 é›†æˆèƒ½åŠ›

| åŠŸèƒ½                | è¯´æ˜                   | ä½¿ç”¨æ–¹å¼                            |
| ------------------- | ---------------------- | ----------------------------------- |
| CI/CDé›†æˆ           | Jenkins/GitHub Actions | CLIæ‰§è¡Œ                             |
| Playwright Reporter | Playwrightæµ‹è¯•æŠ¥å‘Š     | `@midscene/web/playwright-report` |
| MCPåè®®             | Claude Desktopé›†æˆ     | `@midscene/mcp`                   |
| APIæ¥å£             | è¿œç¨‹è°ƒç”¨               | HTTPæ¥å£                            |

### 6.5 å¼€å‘è€…å·¥å…·

| å·¥å…·       | è¯´æ˜                 | ç”¨é€”       |
| ---------- | -------------------- | ---------- |
| Playground | å¯è§†åŒ–æ“ä½œé¢æ¿       | è°ƒè¯•ã€æ¼”ç¤º |
| Visualizer | å¯è§†åŒ–ç»„ä»¶åº“         | æŠ¥å‘Šå±•ç¤º   |
| CLIå·¥å…·    | å‘½ä»¤è¡Œå·¥å…·           | æ‰¹é‡æ‰§è¡Œ   |
| Chromeæ‰©å±• | æµè§ˆå™¨æ‰©å±•           | å½•åˆ¶ã€å›æ”¾ |
| è°ƒè¯•æ—¥å¿—   | `DEBUG=midscene:*` | é—®é¢˜æ’æŸ¥   |

---

## 7. å¯è‡ªå®šä¹‰åŠŸèƒ½æ¸…å•

### 7.1 AIæ¨¡å‹é…ç½®

#### 7.1.1 å…¨å±€é…ç½® (ç¯å¢ƒå˜é‡)

```bash
# é€‰æ‹©é»˜è®¤æ¨¡å‹
MIDSCENE_MODEL_NAME=gpt-4o                    # æˆ– qwen-vl-max, gemini-2.0-flash

# OpenAIé…ç½®
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1    # å¯è‡ªå®šä¹‰ä»£ç†

# Anthropicé…ç½®
ANTHROPIC_API_KEY=sk-ant-xxx

# Google Geminié…ç½®
GEMINI_API_KEY=xxx

# Qwené…ç½®
QWEN_API_KEY=sk-xxx
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

#### 7.1.2 æŒ‰æ„å›¾é…ç½® (ä»£ç çº§)

```typescript
const agent = await PuppeteerAgent.create(page, {
  modelConfig: ({ intent }) => {
    // æ ¹æ®ä¸åŒæ„å›¾è¿”å›ä¸åŒé…ç½®
    if (intent === 'planning') {
      // è§„åˆ’ä»»åŠ¡ç”¨å¤§æ¨¡å‹
      return {
        provider: 'openai',
        model: 'gpt-4o',
        apiKey: process.env.OPENAI_API_KEY,
        temperature: 0.7
      };
    } else if (intent === 'grounding') {
      // å…ƒç´ å®šä½ç”¨è§†è§‰æ¨¡å‹
      return {
        provider: 'qwen',
        model: 'qwen-vl-max',
        apiKey: process.env.QWEN_API_KEY,
        baseURL: process.env.QWEN_BASE_URL
      };
    } else if (intent === 'VQA') {
      // æ•°æ®æå–ç”¨å¿«é€Ÿæ¨¡å‹
      return {
        provider: 'gemini',
        model: 'gemini-2.0-flash-exp',
        apiKey: process.env.GEMINI_API_KEY
      };
    }
    // default
    return {
      provider: 'openai',
      model: 'gpt-4o',
      apiKey: process.env.OPENAI_API_KEY
    };
  }
});
```

**æ”¯æŒçš„Intentç±»å‹:**

1. `planning` - ä»»åŠ¡è§„åˆ’ (aiActionç”Ÿæˆæ‰§è¡Œæ­¥éª¤)
2. `grounding` - å…ƒç´ å®šä½ (aiTap/aiInputå®šä½å…ƒç´ )
3. `VQA` - æ•°æ®æå– (aiQueryæå–æ•°æ®)
4. `default` - é»˜è®¤é…ç½®

### 7.2 è®¾å¤‡æ¥å£è‡ªå®šä¹‰

#### 7.2.1 æ‰©å±•è®¾å¤‡æ¥å£

```typescript
// è‡ªå®šä¹‰æ¡Œé¢åº”ç”¨æ”¯æŒ
class DesktopDevice implements AbstractInterface {
  interfaceType = 'desktop';

  // å®šä¹‰å¯ç”¨æ“ä½œ
  async actionSpace(): Promise<DeviceAction[]> {
    return [
      {
        type: 'Tap',
        execute: async (param) => {
          // ä½¿ç”¨robotjsç­‰å·¥å…·å®ç°ç‚¹å‡»
          robot.moveMouse(param.element.center[0], param.element.center[1]);
          robot.mouseClick();
        }
      },
      {
        type: 'KeyboardPress',
        execute: async (param) => {
          robot.keyTap(param.key);
        }
      }
      // ... æ›´å¤šè‡ªå®šä¹‰æ“ä½œ
    ];
  }

  // è·å–å±å¹•ä¸Šä¸‹æ–‡
  async getContext(): Promise<UIContext> {
    const screenshot = robot.screen.capture();
    return {
      screenshotBase64: imageToBase64(screenshot),
      size: robot.getScreenSize()
    };
  }

  // ... å…¶ä»–å¿…éœ€æ–¹æ³•
}
```

#### 7.2.2 è‡ªå®šä¹‰æ“ä½œåŠ¨ä½œ

```typescript
// æ·»åŠ è‡ªå®šä¹‰æ“ä½œç±»å‹
const customActions: DeviceAction[] = [
  {
    type: 'DoubleClick',
    execute: async (param) => {
      await page.mouse.click(param.center[0], param.center[1], { clickCount: 2 });
    }
  },
  {
    type: 'Hover',
    execute: async (param) => {
      await page.mouse.move(param.center[0], param.center[1]);
    }
  },
  {
    type: 'Drag',
    execute: async (param) => {
      const { from, to } = param;
      await page.mouse.move(from[0], from[1]);
      await page.mouse.down();
      await page.mouse.move(to[0], to[1]);
      await page.mouse.up();
    }
  }
];
```

### 7.3 ç¼“å­˜ç­–ç•¥è‡ªå®šä¹‰

#### 7.3.1 æœ¬åœ°æ–‡ä»¶ç¼“å­˜ (é»˜è®¤)

```typescript
const agent = await PuppeteerAgent.create(page, {
  cache: {
    enabled: true,
    id: 'my-test-suite',              // ç¼“å­˜æ ‡è¯†
    strategy: 'read-write',           // è¯»å†™ç­–ç•¥
    filePath: './cache/my-cache.json' // è‡ªå®šä¹‰è·¯å¾„
  }
});
```

#### 7.3.2 è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥ (Redisç¤ºä¾‹)

```typescript
class RedisCacheStrategy implements CacheStrategy {
  private redis: Redis;

  constructor(redisUrl: string) {
    this.redis = new Redis(redisUrl);
  }

  async get(key: string): Promise<any> {
    const value = await this.redis.get(key);
    return value ? JSON.parse(value) : null;
  }

  async set(key: string, value: any, ttl?: number): Promise<void> {
    const serialized = JSON.stringify(value);
    if (ttl) {
      await this.redis.setex(key, ttl, serialized);
    } else {
      await this.redis.set(key, serialized);
    }
  }

  // ... å…¶ä»–æ–¹æ³•
}

// ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜
const agent = new Agent(page, {
  cacheStrategy: new RedisCacheStrategy('redis://localhost:6379')
});
```

### 7.4 æŠ¥å‘Šç”Ÿæˆè‡ªå®šä¹‰

#### 7.4.1 è‡ªå®šä¹‰æŠ¥å‘Šæ ·å¼

```typescript
// è‡ªå®šä¹‰æŠ¥å‘ŠHTMLæ¨¡æ¿
function customReportTemplate(dumpData: ExecutionDump): string {
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <title>è‡ªå®šä¹‰æµ‹è¯•æŠ¥å‘Š</title>
        <link rel="stylesheet" href="/custom-styles.css">
      </head>
      <body>
        <div id="report-container">
          <h1>${dumpData.groupName}</h1>
          <div class="summary">
            æ€»æ‰§è¡Œ: ${dumpData.executions.length}
            æˆåŠŸ: ${countSuccess(dumpData)}
            å¤±è´¥: ${countFailed(dumpData)}
          </div>
          ${renderExecutions(dumpData.executions)}
        </div>
        <script>
          window.reportData = ${JSON.stringify(dumpData)};
        </script>
      </body>
    </html>
  `;
}

// æ³¨å…¥è‡ªå®šä¹‰æŠ¥å‘Šç”Ÿæˆå™¨
agent.setReportGenerator(customReportTemplate);
```

#### 7.4.2 æŠ¥å‘Šæ•°æ®ä¸Šä¼ 

```typescript
const agent = await PuppeteerAgent.create(page, {
  generateReport: true,
  onDumpUpdate: async (dumpData) => {
    // å®æ—¶ä¸Šä¼ æŠ¥å‘Šæ•°æ®åˆ°æœåŠ¡å™¨
    await fetch('https://your-report-server.com/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        projectId: 'my-project',
        timestamp: Date.now(),
        data: dumpData
      })
    });
  }
});
```

### 7.5 Promptè‡ªå®šä¹‰

#### 7.5.1 è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯

```typescript
// ä¿®æ”¹å…ƒç´ å®šä½çš„ç³»ç»Ÿæç¤ºè¯
import { systemPromptToLocateElement } from '@midscene/core/ai-model';

// è¦†ç›–é»˜è®¤æç¤ºè¯
function customLocatePrompt(userPrompt: string): string {
  return `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„UIè‡ªåŠ¨åŒ–æµ‹è¯•ä¸“å®¶ã€‚
å½“å‰ä»»åŠ¡: å®šä½ç”¨æˆ·æè¿°çš„å…ƒç´  "${userPrompt}"

è¯·åˆ†ææˆªå›¾,æ‰¾åˆ°æœ€åŒ¹é…çš„å…ƒç´ ,è¿”å›å…¶ä½ç½®åæ ‡ã€‚

æ³¨æ„äº‹é¡¹:
- ä¼˜å…ˆåŒ¹é…æ–‡æœ¬å†…å®¹
- è€ƒè™‘å…ƒç´ çš„è§†è§‰å±‚çº§
- è¿”å›æœ€æ˜æ˜¾ã€æœ€å¯æ“ä½œçš„å…ƒç´ 

è¿”å›æ ¼å¼: JSON
  `;
}

// åœ¨Agenté…ç½®ä¸­ä½¿ç”¨
const agent = await PuppeteerAgent.create(page, {
  customPrompts: {
    locate: customLocatePrompt
  }
});
```

#### 7.5.2 æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯

```typescript
// ä¸ºAIæ“ä½œæ·»åŠ å…¨å±€ä¸Šä¸‹æ–‡
await agent.setAIActionContext(`
å½“å‰æµ‹è¯•ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ
ç”¨æˆ·è§’è‰²: ç®¡ç†å‘˜
æµ‹è¯•ç›®æ ‡: éªŒè¯è®¢å•æµç¨‹
æ³¨æ„äº‹é¡¹:
  - ä¸è¦åˆ é™¤çœŸå®æ•°æ®
  - æ“ä½œå‰éœ€è¦ç¡®è®¤
  - è®°å½•æ‰€æœ‰å…³é”®æ­¥éª¤
`);

// åç»­çš„AIæ“ä½œéƒ½ä¼šè€ƒè™‘è¿™ä¸ªä¸Šä¸‹æ–‡
await agent.aiAction('åˆ›å»ºæµ‹è¯•è®¢å•');
```

### 7.6 UIç•Œé¢è‡ªå®šä¹‰

#### 7.6.1 è‡ªå®šä¹‰Playground

```tsx
import { UniversalPlayground } from '@midscene/visualizer';

function MyCustomPlayground() {
  return (
    <UniversalPlayground
      branding={{
        title: 'æˆ‘çš„è‡ªåŠ¨åŒ–å¹³å°',
        logo: '/my-logo.png',
        primaryColor: '#1890ff',
        footer: 'Â© 2025 My Company'
      }}
      config={{
        defaultExecutionType: 'local',
        showAdvancedOptions: true,
        enableCache: true,
        allowedActions: ['aiTap', 'aiInput', 'aiQuery'],  // é™åˆ¶å¯ç”¨æ“ä½œ
        customActions: [
          {
            name: 'æ‰¹é‡æ“ä½œ',
            icon: 'batch',
            handler: async (agent) => {
              // è‡ªå®šä¹‰æ‰¹é‡æ“ä½œé€»è¾‘
            }
          }
        ]
      }}
    />
  );
}
```

#### 7.6.2 è‡ªå®šä¹‰æŠ¥å‘Šç»„ä»¶

```tsx
import { ReportData } from '@midscene/core';
import { Timeline, Screenshot } from '@midscene/visualizer';

function CustomReport({ data }: { data: ReportData }) {
  return (
    <div className="custom-report">
      <header>
        <h1>{data.groupName}</h1>
        <div className="metrics">
          <Metric label="æ€»è€—æ—¶" value={calculateDuration(data)} />
          <Metric label="AIè°ƒç”¨æ¬¡æ•°" value={countAICalls(data)} />
          <Metric label="æˆåŠŸç‡" value={calculateSuccessRate(data)} />
        </div>
      </header>

      <Timeline data={data.executions} />

      <div className="executions">
        {data.executions.map(execution => (
          <ExecutionCard key={execution.id} data={execution} />
        ))}
      </div>
    </div>
  );
}
```

### 7.7 æ’ä»¶ç³»ç»Ÿ (æ‰©å±•ç‚¹)

#### 7.7.1 ç”Ÿå‘½å‘¨æœŸé’©å­

```typescript
const agent = await PuppeteerAgent.create(page, {
  // ä»»åŠ¡å¼€å§‹å‰
  beforeTask: async (taskInfo) => {
    console.log(`å¼€å§‹æ‰§è¡Œ: ${taskInfo.title}`);
    // å¯ä»¥ä¿®æ”¹ä»»åŠ¡é…ç½®ã€è®°å½•æ—¥å¿—ç­‰
  },

  // ä»»åŠ¡å®Œæˆå
  afterTask: async (taskInfo, result) => {
    console.log(`å®Œæˆæ‰§è¡Œ: ${taskInfo.title}, ç»“æœ:`, result);
    // å‘é€é€šçŸ¥ã€ä¸Šä¼ æ•°æ®ç­‰
  },

  // AIè°ƒç”¨å‰
  beforeAICall: async (messages, config) => {
    // è®°å½•AIè°ƒç”¨ã€ä¿®æ”¹æç¤ºè¯ç­‰
    console.log('AIè°ƒç”¨:', config.intent);
  },

  // AIè°ƒç”¨å
  afterAICall: async (messages, config, response) => {
    // ç»Ÿè®¡tokenæ¶ˆè€—ã€åˆ†æå“åº”ç­‰
    console.log('AIå“åº”token:', response.usage.totalTokens);
  },

  // æ“ä½œæ‰§è¡Œå‰
  beforeAction: async (action) => {
    console.log(`å‡†å¤‡æ‰§è¡Œæ“ä½œ: ${action.type}`);
  },

  // æ“ä½œæ‰§è¡Œå
  afterAction: async (action, result) => {
    console.log(`æ“ä½œå®Œæˆ: ${action.type}`);
  }
});
```

#### 7.7.2 è‡ªå®šä¹‰ä¸­é—´ä»¶

```typescript
// æ·»åŠ é‡è¯•ä¸­é—´ä»¶
function retryMiddleware(maxRetries = 3) {
  return {
    beforeAction: async (action, context) => {
      context.retryCount = 0;
    },

    onActionError: async (action, error, context) => {
      if (context.retryCount < maxRetries) {
        context.retryCount++;
        console.log(`é‡è¯• ${context.retryCount}/${maxRetries}`);
        return 'retry';  // æŒ‡ç¤ºæ¡†æ¶é‡è¯•
      }
      return 'throw';  // æŠ›å‡ºé”™è¯¯
    }
  };
}

// æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
function loggingMiddleware(logService) {
  return {
    afterAction: async (action, result) => {
      await logService.log({
        type: action.type,
        timestamp: Date.now(),
        result: result
      });
    }
  };
}

// ä½¿ç”¨ä¸­é—´ä»¶
const agent = await PuppeteerAgent.create(page, {
  middlewares: [
    retryMiddleware(3),
    loggingMiddleware(myLogService)
  ]
});
```

### 7.8 ç¯å¢ƒå˜é‡é…ç½®

#### å®Œæ•´é…ç½®æ¸…å•

```bash
# ===== AIæ¨¡å‹é…ç½® =====
# é»˜è®¤æ¨¡å‹
MIDSCENE_MODEL_NAME=gpt-4o
MIDSCENE_VL_MODE=vlm                          # vlm | vlm-ui-tars

# OpenAI
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MAX_TOKENS=4096

# Anthropic
ANTHROPIC_API_KEY=sk-ant-xxx

# Google Gemini
GEMINI_API_KEY=xxx

# Qwen (é€šä¹‰åƒé—®)
QWEN_API_KEY=sk-xxx
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1

# æŒ‰æ„å›¾é…ç½® (VQAä¸“ç”¨)
MIDSCENE_VQA_MODEL_NAME=gemini-2.0-flash-exp
MIDSCENE_VQA_OPENAI_API_KEY=sk-xxx

# ===== ç¼“å­˜é…ç½® =====
MIDSCENE_CACHE=true                           # å¯ç”¨ç¼“å­˜
MIDSCENE_CACHE_STRATEGY=read-write            # read-only | write-only | read-write
MIDSCENE_CACHE_DIR=./cache                    # ç¼“å­˜ç›®å½•
MIDSCENE_CACHE_MAX_FILENAME_LENGTH=200        # ç¼“å­˜æ–‡ä»¶åæœ€å¤§é•¿åº¦

# ===== æŠ¥å‘Šé…ç½® =====
MIDSCENE_RUN_DIR=./midscene_run               # æŠ¥å‘Šè¾“å‡ºç›®å½•
MIDSCENE_REPORT_TAG_NAME=my-project           # æŠ¥å‘Šæ ‡ç­¾

# ===== è°ƒè¯•é…ç½® =====
DEBUG=midscene:*                              # å¯ç”¨è°ƒè¯•æ—¥å¿—
MIDSCENE_DEBUG_AI_PROFILE=true                # AIæ€§èƒ½åˆ†æ
MIDSCENE_DEBUG_AI_RESPONSE=true               # æ‰“å°AIå“åº”
MIDSCENE_FORCE_DEEP_THINK=true                # å¼ºåˆ¶æ·±åº¦æ€è€ƒæ¨¡å¼

# ===== Androidé…ç½® =====
MIDSCENE_ADB_PATH=/usr/local/bin/adb          # ADBè·¯å¾„
MIDSCENE_ADB_REMOTE_HOST=192.168.1.100        # è¿œç¨‹ADBä¸»æœº
MIDSCENE_ADB_REMOTE_PORT=5555                 # è¿œç¨‹ADBç«¯å£
MIDSCENE_ANDROID_IME_STRATEGY=adb             # è¾“å…¥æ³•ç­–ç•¥

# ===== iOSé…ç½® =====
MIDSCENE_IOS_DEVICE_UDID=xxx                  # iOSè®¾å¤‡UDID
MIDSCENE_IOS_SIMULATOR_UDID=xxx               # æ¨¡æ‹Ÿå™¨UDID

# ===== MCPé…ç½® =====
MIDSCENE_MCP_USE_PUPPETEER_MODE=true          # MCPä½¿ç”¨Puppeteeræ¨¡å¼
MIDSCENE_MCP_CHROME_PATH=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome

# ===== ç½‘ç»œä»£ç† =====
HTTP_PROXY=http://proxy.company.com:8080
HTTPS_PROXY=http://proxy.company.com:8080
MIDSCENE_OPENAI_SOCKS_PROXY=socks5://127.0.0.1:1080

# ===== é«˜çº§é…ç½® =====
MIDSCENE_REPLANNING_CYCLE_LIMIT=10            # é‡æ–°è§„åˆ’å¾ªç¯é™åˆ¶
MIDSCENE_PREFERRED_LANGUAGE=zh                # é¦–é€‰è¯­è¨€ (zh/en)
```

---

## 8. AIæ¨¡å‹æ¶æ„åˆ†æ

### 8.1 æ ¸å¿ƒé—®é¢˜å›ç­”: å•æ¨¡å‹è¿˜æ˜¯å¤šæ¨¡å‹?

**ç­”æ¡ˆ: Midscene.js æ”¯æŒå¤šæ¨¡å‹ååŒå·¥ä½œ âœ…**

#### 8.1.1 æ¶æ„è®¾è®¡

Midscene.js é‡‡ç”¨**åŸºäºæ„å›¾(Intent)çš„å¤šæ¨¡å‹é…ç½®æ¶æ„**,å…è®¸ä¸ºä¸åŒçš„AIä»»åŠ¡é…ç½®ä¸åŒçš„æ¨¡å‹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ModelConfigManager (æ¨¡å‹é…ç½®ç®¡ç†å™¨)          â”‚
â”‚                                                           â”‚
â”‚  Intent â†’ ModelConfig æ˜ å°„å…³ç³»                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  'planning'   â†’ GPT-4o (è§„åˆ’èƒ½åŠ›å¼º)               â”‚   â”‚
â”‚  â”‚  'grounding'  â†’ Qwen-VL (è§†è§‰å®šä½ç²¾å‡†)            â”‚   â”‚
â”‚  â”‚  'VQA'        â†’ Gemini-Flash (æå–å¿«é€Ÿ)           â”‚   â”‚
â”‚  â”‚  'default'    â†’ GPT-4o (é»˜è®¤é…ç½®)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.1.2 å››ç§Intentç±»å‹

1. **`planning` (ä»»åŠ¡è§„åˆ’)**

   - **èŒè´£**: å°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºæ‰§è¡Œæ­¥éª¤
   - **ä½¿ç”¨åœºæ™¯**: `aiAction("å®Œæˆç”¨æˆ·æ³¨å†Œæµç¨‹")`
   - **æ¨èæ¨¡å‹**: GPT-4o, Claude Sonnet (æ¨ç†èƒ½åŠ›å¼º)
   - **è¾“å‡º**: YAMLæ ¼å¼æ‰§è¡Œè®¡åˆ’
2. **`grounding` (å…ƒç´ å®šä½)**

   - **èŒè´£**: åœ¨æˆªå›¾ä¸­å®šä½UIå…ƒç´ çš„åæ ‡
   - **ä½¿ç”¨åœºæ™¯**: `aiTap("ç™»å½•æŒ‰é’®")`, `aiInput("ç”¨æˆ·åè¾“å…¥æ¡†")`
   - **æ¨èæ¨¡å‹**: Qwen-VL, UI-TARS (è§†è§‰å®šä½ä¸“ç”¨)
   - **è¾“å‡º**: å…ƒç´ åæ ‡ `{rect, center}`
3. **`VQA` (è§†è§‰é—®ç­”/æ•°æ®æå–)**

   - **èŒè´£**: ä»é¡µé¢ä¸­æå–æ•°æ®
   - **ä½¿ç”¨åœºæ™¯**: `aiQuery("è·å–å•†å“ä»·æ ¼")`
   - **æ¨èæ¨¡å‹**: Gemini-2.0-Flash, GPT-4o-mini (å¿«é€Ÿã€æˆæœ¬ä½)
   - **è¾“å‡º**: ç»“æ„åŒ–æ•°æ®
4. **`default` (é»˜è®¤é…ç½®)**

   - **èŒè´£**: é€šç”¨é…ç½®,ä½œä¸ºå¤‡ç”¨
   - **ä½¿ç”¨åœºæ™¯**: å…¶ä»–æœªæ˜ç¡®æŒ‡å®šçš„åœºæ™¯
   - **æ¨èæ¨¡å‹**: ä¸ä¸»æ¨¡å‹ä¸€è‡´

### 8.2 å¤šæ¨¡å‹é…ç½®ç¤ºä¾‹

#### 8.2.1 ç¯å¢ƒå˜é‡é…ç½® (å…¨å±€)

```bash
# é»˜è®¤ä½¿ç”¨OpenAI
MIDSCENE_MODEL_NAME=gpt-4o
OPENAI_API_KEY=sk-xxx

# VQAä»»åŠ¡å•ç‹¬é…ç½®ä½¿ç”¨Gemini (æ›´å¿«ã€æ›´ä¾¿å®œ)
MIDSCENE_VQA_MODEL_NAME=gemini-2.0-flash-exp
GEMINI_API_KEY=your-gemini-key

# ç»“æœ:
#   - planning/grounding: GPT-4o
#   - VQA: Gemini-2.0-Flash
```

#### 8.2.2 ä»£ç çº§é…ç½® (æ›´çµæ´»)

```typescript
const agent = await PuppeteerAgent.create(page, {
  modelConfig: ({ intent }) => {
    // æ ¹æ®æ„å›¾è¿”å›ä¸åŒé…ç½®
    switch (intent) {
      case 'planning':
        // ä»»åŠ¡è§„åˆ’: ä½¿ç”¨GPT-4o (æ¨ç†èƒ½åŠ›å¼º)
        return {
          provider: 'openai',
          model: 'gpt-4o',
          apiKey: process.env.OPENAI_API_KEY,
          temperature: 0.7,
          maxTokens: 4096
        };

      case 'grounding':
        // å…ƒç´ å®šä½: ä½¿ç”¨Qwen-VL (è§†è§‰å®šä½ä¸“ç”¨)
        return {
          provider: 'qwen',
          model: 'qwen-vl-max',
          apiKey: process.env.QWEN_API_KEY,
          baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
          vlMode: true  // æ ‡è®°ä¸ºè§†è§‰æ¨¡å‹
        };

      case 'VQA':
        // æ•°æ®æå–: ä½¿ç”¨Gemini-Flash (å¿«é€Ÿä¸”ä¾¿å®œ)
        return {
          provider: 'gemini',
          model: 'gemini-2.0-flash-exp',
          apiKey: process.env.GEMINI_API_KEY,
          temperature: 0.3
        };

      default:
        // é»˜è®¤é…ç½®
        return {
          provider: 'openai',
          model: 'gpt-4o',
          apiKey: process.env.OPENAI_API_KEY
        };
    }
  }
});
```

### 8.3 ä½¿ç”¨å¤šæ¨¡å‹çš„ä¼˜åŠ¿

#### 8.3.1 æ€§èƒ½ä¼˜åŒ–

```
åœºæ™¯: æ‰¹é‡æå–å•†å“ä¿¡æ¯

å•æ¨¡å‹æ–¹æ¡ˆ:
  - å…¨éƒ¨ä½¿ç”¨GPT-4o
  - æˆæœ¬: 100æ¬¡è°ƒç”¨ Ã— $0.01 = $1.00
  - è€—æ—¶: 100æ¬¡ Ã— 2s = 200s

å¤šæ¨¡å‹æ–¹æ¡ˆ:
  - Planning (1æ¬¡): GPT-4o = $0.01
  - Grounding (5æ¬¡): Qwen-VL = $0.02
  - VQA (100æ¬¡): Gemini-Flash = $0.10
  - æ€»æˆæœ¬: $0.13 (èŠ‚çœ 87%)
  - æ€»è€—æ—¶: 1Ã—2s + 5Ã—1.5s + 100Ã—0.5s = 60s (èŠ‚çœ 70%)
```

#### 8.3.2 è´¨é‡ä¿éšœ

```
ä¸åŒæ¨¡å‹çš„ä¼˜åŠ¿:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   ä»»åŠ¡    â”‚   æœ€ä½³æ¨¡å‹    â”‚    åŸå›        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ä»»åŠ¡è§„åˆ’   â”‚ GPT-4o       â”‚ æ¨ç†èƒ½åŠ›å¼º    â”‚
  â”‚ å…ƒç´ å®šä½   â”‚ Qwen-VL      â”‚ è§†è§‰ä¸“ç”¨è®­ç»ƒ  â”‚
  â”‚ æ•°æ®æå–   â”‚ Gemini-Flash â”‚ å¿«é€Ÿ+å‡†ç¡®     â”‚
  â”‚ å¤æ‚æ¨ç†   â”‚ Claude-Opus  â”‚ æ·±åº¦æ€è€ƒ      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3.3 æˆæœ¬æ§åˆ¶

```typescript
// é«˜é¢‘æ“ä½œä½¿ç”¨ä¾¿å®œæ¨¡å‹
const agent = await PuppeteerAgent.create(page, {
  modelConfig: ({ intent }) => {
    if (intent === 'VQA') {
      // æ•°æ®æå–é¢‘ç‡é«˜,ä½¿ç”¨ä¾¿å®œçš„æ¨¡å‹
      return {
        provider: 'gemini',
        model: 'gemini-2.0-flash-exp',
        apiKey: process.env.GEMINI_API_KEY
      };
    } else if (intent === 'planning') {
      // ä»»åŠ¡è§„åˆ’é¢‘ç‡ä½,ä½¿ç”¨é«˜è´¨é‡æ¨¡å‹
      return {
        provider: 'anthropic',
        model: 'claude-3-opus-20240229',
        apiKey: process.env.ANTHROPIC_API_KEY
      };
    }
    // ...
  }
});
```

### 8.4 æ¨èçš„å¤šæ¨¡å‹é…ç½®æ–¹æ¡ˆ

#### 8.4.1 æ–¹æ¡ˆä¸€: æˆæœ¬ä¼˜å…ˆ

```typescript
{
  planning: 'gpt-4o-mini',        // æ¨ç† (ä¾¿å®œ)
  grounding: 'qwen-vl-plus',      // å®šä½ (ä¸­ç­‰)
  VQA: 'gemini-2.0-flash',        // æå– (æœ€ä¾¿å®œ)
  default: 'gpt-4o-mini'
}

é¢„ä¼°æˆæœ¬ (1000æ¬¡æ“ä½œ):
  - Planning: 10æ¬¡ Ã— $0.002 = $0.02
  - Grounding: 100æ¬¡ Ã— $0.005 = $0.50
  - VQA: 1000æ¬¡ Ã— $0.0001 = $0.10
  æ€»è®¡: $0.62
```

#### 8.4.2 æ–¹æ¡ˆäºŒ: è´¨é‡ä¼˜å…ˆ

```typescript
{
  planning: 'claude-3-opus',      // æ¨ç† (æœ€å¼º)
  grounding: 'qwen-vl-max',       // å®šä½ (æœ€å‡†)
  VQA: 'gpt-4o',                  // æå– (å‡†ç¡®)
  default: 'gpt-4o'
}

é¢„ä¼°æˆæœ¬ (1000æ¬¡æ“ä½œ):
  - Planning: 10æ¬¡ Ã— $0.015 = $0.15
  - Grounding: 100æ¬¡ Ã— $0.01 = $1.00
  - VQA: 1000æ¬¡ Ã— $0.005 = $5.00
  æ€»è®¡: $6.15
```

#### 8.4.3 æ–¹æ¡ˆä¸‰: å¹³è¡¡æ–¹æ¡ˆ (æ¨è)

```typescript
{
  planning: 'gpt-4o',             // æ¨ç† (å¹³è¡¡)
  grounding: 'qwen-vl-max',       // å®šä½ (ä¸“ç”¨)
  VQA: 'gemini-2.0-flash',        // æå– (å¿«é€Ÿ)
  default: 'gpt-4o'
}

é¢„ä¼°æˆæœ¬ (1000æ¬¡æ“ä½œ):
  - Planning: 10æ¬¡ Ã— $0.01 = $0.10
  - Grounding: 100æ¬¡ Ã— $0.01 = $1.00
  - VQA: 1000æ¬¡ Ã— $0.0001 = $0.10
  æ€»è®¡: $1.20
```

### 8.5 å®é™…åº”ç”¨æ¡ˆä¾‹

#### 8.5.1 ç”µå•†è‡ªåŠ¨åŒ–æµ‹è¯•

```typescript
const agent = await PuppeteerAgent.create(page, {
  modelConfig: ({ intent }) => {
    if (intent === 'planning') {
      // å¤æ‚çš„è´­ç‰©æµç¨‹è§„åˆ’,ä½¿ç”¨å¼ºæ¨ç†æ¨¡å‹
      return {
        provider: 'openai',
        model: 'gpt-4o',
        apiKey: process.env.OPENAI_API_KEY
      };
    } else if (intent === 'grounding') {
      // å®šä½å•†å“ã€æŒ‰é’®,ä½¿ç”¨è§†è§‰ä¸“ç”¨æ¨¡å‹
      return {
        provider: 'qwen',
        model: 'qwen-vl-max',
        apiKey: process.env.QWEN_API_KEY,
        baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
      };
    } else if (intent === 'VQA') {
      // æ‰¹é‡æå–å•†å“ä¿¡æ¯,ä½¿ç”¨å¿«é€Ÿæ¨¡å‹
      return {
        provider: 'gemini',
        model: 'gemini-2.0-flash-exp',
        apiKey: process.env.GEMINI_API_KEY
      };
    }
  }
});

// ä½¿ç”¨ç¤ºä¾‹
await agent.aiAction('å®Œæˆè´­ä¹°æµç¨‹');              // ä½¿ç”¨GPT-4oè§„åˆ’
await agent.aiTap('åŠ å…¥è´­ç‰©è½¦æŒ‰é’®');               // ä½¿ç”¨Qwen-VLå®šä½
const price = await agent.aiQuery('å•†å“ä»·æ ¼');    // ä½¿ç”¨Geminiæå–
```

#### 8.5.2 ç§»åŠ¨ç«¯UIæµ‹è¯•

```typescript
const agent = await AndroidAgent.create({
  modelConfig: ({ intent }) => {
    if (intent === 'planning') {
      // å¤æ‚çš„APPæ“ä½œæµç¨‹
      return { provider: 'openai', model: 'gpt-4o', ... };
    } else if (intent === 'grounding') {
      // å®šä½Android UIå…ƒç´ 
      return { provider: 'qwen', model: 'qwen-vl-max', ... };
    } else if (intent === 'VQA') {
      // æå–APPæ•°æ®
      return { provider: 'gemini', model: 'gemini-2.0-flash', ... };
    }
  }
});

// å¤æ‚ä»»åŠ¡: è‡ªåŠ¨è§„åˆ’ (GPT-4o)
await agent.aiAction('å®Œæˆç”¨æˆ·æ³¨å†Œæµç¨‹');

// å…ƒç´ å®šä½: è§†è§‰æ¨¡å‹ (Qwen-VL)
await agent.aiTap('æ³¨å†ŒæŒ‰é’®');

// æ•°æ®æå–: å¿«é€Ÿæ¨¡å‹ (Gemini)
const welcomeMsg = await agent.aiQuery('æ¬¢è¿ä¿¡æ¯');
```

### 8.6 æŠ€æœ¯å®ç°ç»†èŠ‚

#### 8.6.1 ModelConfigManageræ ¸å¿ƒä»£ç 

```typescript
// packages/shared/src/env/model-config-manager.ts

export class ModelConfigManager {
  private modelConfigMap: Record<TIntent, IModelConfig>;

  constructor(modelConfigFn?: TModelConfigFn) {
    if (modelConfigFn) {
      // ä¸ºæ¯ä¸ªIntentè®¡ç®—é…ç½®
      const intentConfigMap = this.calcIntentConfigMap(modelConfigFn);
      this.modelConfigMap = this.calcModelConfigMapBaseOnIntent(intentConfigMap);
    }
  }

  // æ ¸å¿ƒæ–¹æ³•: æ ¹æ®Intentè·å–é…ç½®
  getModelConfig(intent: TIntent): IModelConfig {
    return this.modelConfigMap[intent];
  }

  private calcIntentConfigMap(modelConfigFn: TModelConfigFn): TIntentConfigMap {
    const intentConfigMap: TIntentConfigMap = {};

    // éå†æ‰€æœ‰Intentç±»å‹
    for (const intent of ['VQA', 'default', 'grounding', 'planning']) {
      // è°ƒç”¨ç”¨æˆ·æä¾›çš„é…ç½®å‡½æ•°
      const result = modelConfigFn({ intent });
      intentConfigMap[intent] = result;
    }

    return intentConfigMap;
  }
}
```

#### 8.6.2 Agentè°ƒç”¨æµç¨‹

```typescript
// packages/core/src/agent/agent.ts

class Agent {
  modelConfigManager: ModelConfigManager;

  async aiAction(taskPrompt: string) {
    // è·å–planningæ„å›¾çš„æ¨¡å‹é…ç½®
    const modelConfig = this.modelConfigManager.getModelConfig('planning');

    // ä½¿ç”¨è¯¥é…ç½®è°ƒç”¨AIæ¨¡å‹
    const { output } = await this.taskExecutor.action(
      taskPrompt,
      modelConfig,  // ä¼ å…¥planningæ¨¡å‹é…ç½®
      this.opts.aiActionContext
    );

    return output;
  }

  async aiTap(locatePrompt: string) {
    // è·å–groundingæ„å›¾çš„æ¨¡å‹é…ç½®
    const modelConfig = this.modelConfigManager.getModelConfig('grounding');

    // ä½¿ç”¨è¯¥é…ç½®å®šä½å…ƒç´ 
    const element = await this.insight.locate(locatePrompt, modelConfig);

    // æ‰§è¡Œç‚¹å‡»
    await this.interface.tap(element.center);
  }

  async aiQuery<T>(demand: string): Promise<T> {
    // è·å–VQAæ„å›¾çš„æ¨¡å‹é…ç½®
    const modelConfig = this.modelConfigManager.getModelConfig('VQA');

    // ä½¿ç”¨è¯¥é…ç½®æå–æ•°æ®
    const { output } = await this.taskExecutor.createTypeQueryExecution(
      'Query',
      demand,
      modelConfig  // ä¼ å…¥VQAæ¨¡å‹é…ç½®
    );

    return output as T;
  }
}
```

### 8.7 æ€»ç»“: ä¸ºä»€ä¹ˆå¤šæ¨¡å‹æ›´åˆç†?

#### âœ… ä¼˜åŠ¿

1. **ä¸“æ¨¡ä¸“ç”¨**: æ¯ä¸ªä»»åŠ¡ä½¿ç”¨æœ€æ“…é•¿çš„æ¨¡å‹

   - Planning â†’ GPT-4o (æ¨ç†èƒ½åŠ›)
   - Grounding â†’ Qwen-VL (è§†è§‰ä¸“ç”¨)
   - VQA â†’ Gemini-Flash (å¿«é€Ÿæå–)
2. **æˆæœ¬ä¼˜åŒ–**: é«˜é¢‘ä½éš¾åº¦ä»»åŠ¡ç”¨ä¾¿å®œæ¨¡å‹,é™ä½æ•´ä½“æˆæœ¬
3. **æ€§èƒ½æå‡**: å¿«é€Ÿæ¨¡å‹å¤„ç†ç®€å•ä»»åŠ¡,æé«˜æ‰§è¡Œæ•ˆç‡
4. **çµæ´»é…ç½®**: å¯æ ¹æ®é¡¹ç›®éœ€æ±‚è‡ªç”±ç»„åˆæ¨¡å‹
5. **å®¹ç¾èƒ½åŠ›**: æŸä¸ªæ¨¡å‹æœåŠ¡ä¸å¯ç”¨æ—¶,å¯åˆ‡æ¢å¤‡ç”¨æ¨¡å‹

#### ğŸ¯ æ¨èé…ç½®

```typescript
// ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
const productionConfig = {
  modelConfig: ({ intent }) => {
    const configs = {
      planning: {
        provider: 'openai',
        model: 'gpt-4o',               // ä»»åŠ¡è§„åˆ’éœ€è¦å¼ºæ¨ç†
        apiKey: process.env.OPENAI_API_KEY
      },
      grounding: {
        provider: 'qwen',
        model: 'qwen-vl-max',          // è§†è§‰å®šä½ä¸“ç”¨
        apiKey: process.env.QWEN_API_KEY,
        baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
      },
      VQA: {
        provider: 'gemini',
        model: 'gemini-2.0-flash-exp', // æ•°æ®æå–å¿«é€Ÿä¸”ä¾¿å®œ
        apiKey: process.env.GEMINI_API_KEY
      },
      default: {
        provider: 'openai',
        model: 'gpt-4o',
        apiKey: process.env.OPENAI_API_KEY
      }
    };

    return configs[intent] || configs.default;
  }
};
```

---

## ç»“è¯­

**Midscene.js** æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯çš„ç°ä»£åŒ–AIè‡ªåŠ¨åŒ–æ¡†æ¶,å…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äº:

1. **åˆ›æ–°çš„è§†è§‰ç†è§£èƒ½åŠ›**: æ‘†è„±ä¼ ç»Ÿé€‰æ‹©å™¨æŸç¼š,ä½¿ç”¨AI"çœ‹æ‡‚"ç•Œé¢
2. **å¤šæ¨¡å‹ååŒæ¶æ„**: æ”¯æŒæŒ‰æ„å›¾é…ç½®ä¸åŒAIæ¨¡å‹,å®ç°æ€§èƒ½ã€æˆæœ¬ã€è´¨é‡çš„æœ€ä½³å¹³è¡¡
3. **ç»Ÿä¸€çš„è·¨å¹³å°API**: Web/Android/iOSä½¿ç”¨ç›¸åŒçš„API,é™ä½å­¦ä¹ æˆæœ¬
4. **å®Œå–„çš„å·¥ç¨‹åŒ–æ”¯æŒ**: ç¼“å­˜ã€æŠ¥å‘Šã€å¯è§†åŒ–ã€CLIç­‰å®Œæ•´çš„å·¥å…·é“¾
5. **é«˜åº¦å¯æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰è®¾å¤‡æ¥å£ã€AIæ¨¡å‹ã€ç¼“å­˜ç­–ç•¥ã€UIç•Œé¢ç­‰

å¯¹äºå›¢é˜Ÿæ¥è¯´,**å»ºè®®ä½¿ç”¨å¤šæ¨¡å‹é…ç½®æ–¹æ¡ˆ**:

- **ä»»åŠ¡è§„åˆ’ (Planning)**: ä½¿ç”¨GPT-4oæˆ–Claude,ç¡®ä¿å¤æ‚ä»»åŠ¡åˆ†è§£å‡†ç¡®
- **å…ƒç´ å®šä½ (Grounding)**: ä½¿ç”¨Qwen-VLæˆ–UI-TARS,ä¸“ç”¨è§†è§‰æ¨¡å‹å®šä½æ›´ç²¾å‡†
- **æ•°æ®æå– (VQA)**: ä½¿ç”¨Gemini-Flashæˆ–GPT-4o-mini,é™ä½é«˜é¢‘è°ƒç”¨æˆæœ¬

è¿™ç§æ¶æ„æ—¢ä¿è¯äº†è´¨é‡,åˆä¼˜åŒ–äº†æˆæœ¬,æ˜¯AIæ—¶ä»£è‡ªåŠ¨åŒ–æµ‹è¯•çš„æœ€ä½³å®è·µã€‚

---

**æ–‡æ¡£ç¼–åˆ¶**: å­™é¡ºè¾¾
**å®¡æ ¸**: æŠ€æœ¯å›¢é˜Ÿ
**æ›´æ–°**: 2025-11-13
**ç‰ˆæœ¬**: v1.0
